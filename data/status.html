<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pipeline Status ‚Äî Islamic Cartography</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; font-size: 13px;
         background: #f5f5f7; color: #1d1d1f; }
  header { background: #1c1c1e; color: #fff; padding: 14px 24px;
            display: flex; align-items: center; gap: 20px; }
  header h1 { font-size: 16px; font-weight: 600; }
  header p  { font-size: 12px; color: #98989d; margin-top: 2px; flex: 1; }
  .site-nav { display: flex; gap: 12px; margin-left: auto; }
  .site-nav a { font-size: 12px; color: #98989d; text-decoration: none;
    padding: 4px 10px; border-radius: 6px; border: 1px solid #444;
    transition: color .15s, border-color .15s; }
  .site-nav a:hover { color: #fff; border-color: #888; }
  .site-nav a.active { color: #fff; border-color: #0071e3; }

  .content { padding: 20px 24px; }

  .stats { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  .stat { background: #fff; border-radius: 10px; padding: 14px 18px;
           min-width: 110px; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
  .stat .val { font-size: 28px; font-weight: 700; color: #0071e3; }
  .stat .lbl { font-size: 11px; color: #6e6e73; margin-top: 2px; }
  .stat.ok   .val { color: #34c759; }
  .stat.err  .val { color: #ff3b30; }
  .stat.prog .val { color: #ff9f0a; }
  .stat.skip .val { color: #8e8e93; }

  .refresh-info { font-size: 11px; color: #8e8e93; margin-bottom: 16px; }
  .refresh-info span { color: #0071e3; cursor: pointer; }
  .refresh-info span:hover { text-decoration: underline; }

  .progress-bar-wrap { background: #e0e0e5; border-radius: 6px; height: 8px;
                        margin-bottom: 20px; overflow: hidden; }
  .progress-bar { height: 100%; background: #34c759; border-radius: 6px;
                   transition: width 0.5s; }

  .section-title { font-size: 12px; font-weight: 600; color: #6e6e73;
                    text-transform: uppercase; letter-spacing: .05em;
                    margin-bottom: 8px; margin-top: 20px; }

  table { border-collapse: collapse; width: 100%; background: #fff;
           border-radius: 10px; overflow: hidden;
           box-shadow: 0 1px 3px rgba(0,0,0,.08); }
  th { background: #f5f5f7; padding: 8px 10px; text-align: left;
        font-size: 11px; font-weight: 600; color: #6e6e73;
        border-bottom: 1px solid #e0e0e5; white-space: nowrap; }
  td { padding: 6px 10px; border-bottom: 1px solid #f0f0f2; vertical-align: top; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #fafafa; }
  .key { font-family: monospace; font-size: 11px; color: #8e8e93; }
  .title-col { max-width: 360px; }
  .num { text-align: right; font-variant-numeric: tabular-nums; color: #444; }
  .ts { font-size: 11px; color: #aaa; white-space: nowrap; }

  .badge { display: inline-block; padding: 2px 7px; border-radius: 4px;
            font-size: 11px; font-weight: 500; }
  .b-ok       { background: #e8f8ed; color: #1a7f37; }
  .b-error    { background: #fde8e8; color: #c0392b; }
  .b-progress { background: #fff3e0; color: #b45309; }
  .b-skip     { background: #f0f0f0; color: #666; }
  .b-queued   { background: #e8f0fe; color: #1a56db; }

  .q-good    { color: #34c759; }
  .q-suspect { color: #ff9f0a; }
  .q-garbled { color: #ff3b30; }

  .no-status { text-align: center; padding: 60px 20px; color: #8e8e93; }
  .no-status h2 { font-size: 18px; margin-bottom: 8px; }
  .no-status code { font-size: 13px; background: #f0f0f0; padding: 2px 6px;
                     border-radius: 4px; }

  .error-text { font-size: 11px; color: #ff3b30; font-family: monospace;
                 max-width: 300px; word-break: break-word; }
  .cmd { background: #1c1c1e; color: #a8e8a8; padding: 10px 14px; border-radius: 8px;
          font-family: monospace; font-size: 12px; margin: 10px 0; line-height: 1.7; }
</style>
</head>
<body>

<header>
  <div>
    <h1>Islamic Cartography ‚Äî Pipeline Status</h1>
    <p id="header-sub">Loading‚Ä¶</p>
  </div>
  <nav class="site-nav">
    <a href="dashboard.html">üìã Dashboard</a>
    <a href="explore.html">üî≠ Explorer</a>
    <a href="status.html" class="active">‚öôÔ∏è Status</a>
    <a href="chat.html">üí¨ Chat</a>
  </nav>
</header>

<div class="content">
  <div id="main"></div>
</div>

<script>
const POLL_INTERVAL = 5000; // ms
let pollTimer = null;

function fmt(n) {
  return n == null ? '‚Äî' : Number(n).toLocaleString();
}

function reltime(iso) {
  if (!iso) return '‚Äî';
  const d = new Date(iso.replace('T', ' ') + 'Z');
  if (isNaN(d)) return iso;
  const s = Math.round((Date.now() - d) / 1000);
  if (s < 5) return 'just now';
  if (s < 60) return `${s}s ago`;
  if (s < 3600) return `${Math.floor(s/60)}m ago`;
  return `${Math.floor(s/3600)}h ago`;
}

function badgeState(state) {
  const map = {
    ok: '<span class="badge b-ok">‚úì done</span>',
    error: '<span class="badge b-error">‚úó error</span>',
    in_progress: '<span class="badge b-progress">‚ü≥ running</span>',
    skip: '<span class="badge b-skip">‚Äì skipped</span>',
    queued: '<span class="badge b-queued">‚åõ queued</span>',
  };
  return map[state] || `<span class="badge b-skip">${state}</span>`;
}

function qualityIcon(q) {
  if (!q) return '';
  const map = { good: '‚úì', suspect: '‚ö†', garbled: '‚úó' };
  const cls  = { good: 'q-good', suspect: 'q-suspect', garbled: 'q-garbled' };
  return `<span class="${cls[q] || ''}">${map[q] || q} ${q}</span>`;
}

function render(data) {
  const docs = data.docs || {};
  const keys = Object.keys(docs);

  let nOk = 0, nErr = 0, nProg = 0, nSkip = 0;
  keys.forEach(k => {
    const s = docs[k].state;
    if (s === 'ok') nOk++;
    else if (s === 'error') nErr++;
    else if (s === 'in_progress') nProg++;
    else if (s === 'skip') nSkip++;
  });
  const nTotal = nOk + nErr + nProg; // don't count skips in progress bar
  const pct    = nTotal ? Math.round((nOk + nErr) / nTotal * 100) : 0;

  document.getElementById('header-sub').textContent =
    `Started ${reltime(data.started_at)} ¬∑ Last update ${reltime(data.last_updated)}`;

  // Sort: in_progress first, then errors, then ok, then skip
  const order = { in_progress: 0, error: 1, ok: 2, skip: 3 };
  const sorted = keys.sort((a, b) => {
    const oa = order[docs[a].state] ?? 9;
    const ob = order[docs[b].state] ?? 9;
    if (oa !== ob) return oa - ob;
    // Secondary: most recently updated first
    return (docs[b].updated_at || '').localeCompare(docs[a].updated_at || '');
  });

  const rows = sorted.map(key => {
    const d = docs[key];
    const chars = d.chars ? `${fmt(d.chars)} chars` : '';
    const pages = d.pages ? `${d.pages} pp` : '';
    const metric = [chars, pages].filter(Boolean).join(' ¬∑ ');
    return `<tr>
      <td>${badgeState(d.state)}</td>
      <td class="key">${key}</td>
      <td class="title-col">${d.title || ''}</td>
      <td>${metric}</td>
      <td>${d.text_quality ? qualityIcon(d.text_quality) : ''}</td>
      <td class="ts">${reltime(d.updated_at)}</td>
      <td>${d.error ? `<span class="error-text">${d.error}</span>` : ''}</td>
    </tr>`;
  }).join('');

  const inProgressSection = nProg ? `
    <div class="section-title">Currently Running (${nProg})</div>
  ` : (nOk + nErr === 0 ? `
    <div class="section-title">No extraction running</div>
    <p style="color:#8e8e93; font-size:12px; margin-bottom:16px;">
      Start extraction with:<br>
      <span class="cmd">nohup python scripts/05b_extract_robust.py &gt; /tmp/extract.log 2&gt;&amp;1 &amp;<br>tail -f /tmp/extract.log</span>
    </p>
  ` : '');

  document.getElementById('main').innerHTML = `
    <div class="stats">
      <div class="stat ok"><div class="val">${nOk}</div><div class="lbl">Extracted OK</div></div>
      <div class="stat prog"><div class="val">${nProg}</div><div class="lbl">Running now</div></div>
      <div class="stat err"><div class="val">${nErr}</div><div class="lbl">Errors</div></div>
      <div class="stat skip"><div class="val">${nSkip}</div><div class="lbl">Skipped</div></div>
    </div>

    ${nTotal > 0 ? `
    <div class="progress-bar-wrap" title="${pct}% complete">
      <div class="progress-bar" style="width:${pct}%"></div>
    </div>` : ''}

    <div class="refresh-info">
      Auto-refreshes every 5 seconds ¬∑ <span onclick="load()">refresh now</span>
    </div>

    ${inProgressSection}

    ${sorted.length > 0 ? `
    <div class="section-title">All Docs (${sorted.length})</div>
    <table>
      <thead><tr>
        <th>State</th><th>Key</th><th>Title</th>
        <th>Size</th><th>Quality</th><th>Updated</th><th>Error</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>` : ''}
  `;
}

function renderEmpty() {
  document.getElementById('main').innerHTML = `
    <div class="no-status">
      <h2>No pipeline_status.json found</h2>
      <p>Run the extraction script to start:</p>
      <div class="cmd">
        nohup python scripts/05b_extract_robust.py &gt; /tmp/extract.log 2&gt;&amp;1 &amp;<br>
        tail -f /tmp/extract.log
      </div>
      <p style="margin-top:12px;font-size:12px;">This page will auto-refresh when extraction starts.</p>
    </div>
  `;
}

async function load() {
  try {
    const r = await fetch('pipeline_status.json?_=' + Date.now());
    if (!r.ok) { renderEmpty(); return; }
    const data = await r.json();
    render(data);
  } catch (e) {
    renderEmpty();
  }
}

function startPolling() {
  load();
  pollTimer = setInterval(load, POLL_INTERVAL);
}

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    clearInterval(pollTimer);
  } else {
    startPolling();
  }
});

startPolling();
</script>
</body>
</html>
