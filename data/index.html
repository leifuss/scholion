<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scholion</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:      #111;
  --panel:   #1a1a1a;
  --border:  #2e2e2e;
  --text:    #d8d8d8;
  --muted:   #666;
  --accent:  #0071e3;
  --link:    #5ba3f5;
}

body {
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ── Header ── */
header {
  background: #0a0a0a;
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  height: 52px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  flex-shrink: 0;
}
.header-logo {
  font-family: 'Cormorant Garamond', Georgia, serif;
  font-size: 26px;
  font-weight: 600;
  color: #fff;
  letter-spacing: .04em;
  text-decoration: none;
  line-height: 1;
}
.header-logo:hover { color: #ccc; }
.header-right {
  display: flex;
  align-items: center;
  gap: 6px;
}
.header-nav-link {
  font-size: 12px;
  color: var(--muted);
  text-decoration: none;
  padding: 5px 10px;
  border-radius: 5px;
  transition: color .15s, background .15s;
}
.header-nav-link:hover { color: #fff; background: #1e1e1e; }
.header-sub {
  font-size: 11px;
  color: #333;
  padding: 0 4px;
  user-select: none;
}

/* ── Main content ── */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 48px 24px 60px;
  gap: 52px;
}

/* ── Section ── */
.section {
  width: 100%;
  max-width: 900px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

.section-header h2 {
  font-size: 20px;
  font-weight: 600;
  color: #fff;
}

.intro {
  font-size: 14px;
  color: var(--muted);
  line-height: 1.6;
}

/* ── Action button ── */
.btn-action {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: var(--accent);
  color: #fff;
  font-size: 12px;
  font-weight: 500;
  padding: 6px 14px;
  border-radius: 6px;
  text-decoration: none;
  white-space: nowrap;
  transition: background .15s;
  flex-shrink: 0;
}
.btn-action:hover { background: #0060c0; color: #fff; text-decoration: none; }
.btn-action.btn-secondary {
  background: transparent;
  color: var(--link);
  border: 1px solid #2a4a6a;
}
.btn-action.btn-secondary:hover { background: #0d1f30; }

/* ── Collection cards grid ── */
.collection-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
  width: 100%;
}

.collection-card-wrap {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.btn-resync {
  align-self: flex-start;
  background: transparent;
  border: 1px solid #333;
  border-radius: 6px;
  color: var(--muted);
  cursor: pointer;
  font-size: 11px;
  padding: 4px 10px;
  transition: border-color .2s, color .2s;
}
.btn-resync:hover { border-color: var(--accent); color: var(--accent); }
.btn-resync:disabled { opacity: .5; cursor: default; }

/* ── Scan status on collection cards ── */
.card-scan {
  font-size: 11px;
  color: #555;
  margin-top: -2px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.card-scan.scan-needed { color: #b08040; }
.scan-bar-wrap {
  height: 3px;
  background: #2a2a2a;
  border-radius: 2px;
  overflow: hidden;
  width: 100%;
}
.scan-bar-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: width .4s;
}
.scan-bar-text { font-size: 10px; color: #666; }

.collection-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 24px 28px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  transition: border-color .2s, transform .15s, box-shadow .2s;
  cursor: pointer;
  text-decoration: none;
  color: inherit;
}
.collection-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0,0,0,.3);
  text-decoration: none;
  color: inherit;
}

.collection-card .card-breadcrumb {
  font-size: 10px;
  color: #555;
  letter-spacing: .02em;
  margin-bottom: -4px;
}
.collection-card .card-name {
  font-size: 17px;
  font-weight: 600;
  color: #fff;
}
.collection-card .card-desc {
  font-size: 13px;
  color: var(--muted);
  line-height: 1.5;
}
.collection-card .card-meta {
  font-size: 11px;
  color: #555;
  margin-top: 4px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.collection-card .card-badges {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 2px;
}
.collection-card .badge {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  white-space: nowrap;
}
.b-items   { background: #1a2a3a; color: #5a9fd4; border: 1px solid #1a4a6a; }
.b-status  { background: #1a3a1a; color: #5fba7d; border: 1px solid #2a5a2a; }
.b-pending { background: #2a2000; color: #d4b05a; border: 1px solid #4a3800; }
.b-source  { background: #222;    color: #999;    border: 1px solid #333; }
.b-group   { background: #1e1a2e; color: #9a7fd4; border: 1px solid #3a2a5a; }
.collection-card .card-stats {
  font-size: 11px;
  color: #888;
  margin-top: 2px;
}
.collection-card .card-arrow {
  font-size: 12px;
  color: var(--accent);
  margin-top: auto;
  padding-top: 8px;
}

/* ── Discover cards ── */
.discover-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px 24px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.discover-card .card-name {
  font-size: 15px;
  font-weight: 600;
  color: #fff;
}

.discover-card .card-count {
  font-size: 12px;
  color: var(--muted);
}

.selector-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 4px;
}

.selector-chip {
  font-family: ui-monospace, 'SF Mono', 'Cascadia Code', monospace;
  font-size: 12px;
  background: #0d0d0d;
  color: #7fba00;
  border: 1px solid #2a3a20;
  border-radius: 5px;
  padding: 3px 9px;
  user-select: all;
  cursor: default;
  flex-shrink: 0;
}

.btn-copy {
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 5px;
  border: 1px solid var(--border);
  background: #222;
  color: var(--muted);
  cursor: pointer;
  white-space: nowrap;
  transition: background .15s, color .15s;
}
.btn-copy:hover  { background: #2a2a2a; color: var(--text); }
.btn-copy.copied { background: #1a3a1a; color: #5fba7d; border-color: #2a5a2a; }

.btn-add-link {
  font-size: 11px;
  color: var(--link);
  text-decoration: none;
  padding: 3px 8px;
  border: 1px solid #2a4a6a;
  border-radius: 5px;
  background: transparent;
  white-space: nowrap;
  transition: background .15s, color .15s;
  flex-shrink: 0;
  cursor: pointer;
  font-family: inherit;
}
.btn-add-link:hover { background: #0d1f30; }
.btn-add-link:disabled { cursor: default; opacity: .8; }

/* ── Info / notice boxes ── */
.notice-box {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 28px 32px;
  max-width: 600px;
  color: var(--muted);
  font-size: 14px;
  line-height: 1.7;
}
.notice-box p + p { margin-top: 10px; }

.all-active-msg {
  font-size: 13px;
  color: var(--muted);
  padding: 8px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ── Loading / error ── */
.loading-msg {
  text-align: center;
  padding: 40px 24px;
  color: var(--muted);
  font-size: 14px;
}

/* ── Scrollbars ── */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
</style>
</head>
<body>

<header>
  <a class="header-logo" href="#">Scholion</a>
  <div class="header-right">
    <a class="header-nav-link" href="#" title="About Scholion">About</a>
    <span class="header-sub">|</span>
    <a class="header-nav-link" href="#" title="User guide">Guide</a>
    <span class="header-sub">|</span>
    <a id="header-discover-btn" class="btn-action" href="#" target="_blank" rel="noopener"
       title="Scan your Zotero account for all available libraries and collections">
      &#8599;&nbsp;Discover Collections
    </a>
  </div>
</header>

<div class="main">

  <!-- ── Section 1: Your Collections ── -->
  <section class="section">
    <div class="section-header">
      <h2>Your Collections</h2>
      <span id="subtitle" style="font-size:12px;color:var(--muted)"></span>
    </div>
    <p class="intro">Select a collection to explore its documents, timeline, map, and full-text reader.</p>
    <div class="collection-grid" id="grid">
      <p class="loading-msg">Loading collections&hellip;</p>
    </div>
  </section>

  <!-- ── Section 2: Discover More ── -->
  <section class="section">
    <div class="section-header">
      <h2>Discover More</h2>
      <a id="discover-btn" class="btn-action" href="#" target="_blank" rel="noopener">
        &#8599; Discover Collections
      </a>
    </div>
    <div id="discover-content">
      <p class="loading-msg">Checking for discovery data&hellip;</p>
    </div>
  </section>

</div>

<script>
'use strict';

// ── GitHub URL derivation ────────────────────────────────────────────────────
let GITHUB_URL = '';
(function () {
  const m = window.location.hostname.match(/^([^.]+)\.github\.io$/);
  if (m) {
    const owner = m[1];
    const repo  = window.location.pathname.split('/').filter(Boolean)[0] || '';
    GITHUB_URL  = 'https://github.com/' + owner + '/' + repo;
  }
})();

function workflowUrl(filename) {
  if (!GITHUB_URL) return '#';
  return GITHUB_URL + '/actions/workflows/' + filename;
}

// Wire up the Discover Collections buttons (header + section) now, before any fetch
var _discoverUrl = workflowUrl('discover-collections.yml');
document.getElementById('discover-btn').href        = _discoverUrl;
document.getElementById('header-discover-btn').href = _discoverUrl;

// ── Utilities ────────────────────────────────────────────────────────────────
function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function fmtDate(iso) {
  if (!iso) return '';
  try {
    var d = new Date(iso);
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) +
           ' ' + d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
  } catch (e) { return iso.slice(0, 16).replace('T', ' '); }
}

function makeSelector(libType, libId, collKey) {
  const prefix = libType === 'group' ? 'G:' + libId + ':' : 'U::';
  return prefix + (collKey || '');
}

function copySelector(btn, sel) {
  navigator.clipboard.writeText(sel).then(function () {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(function () {
      btn.textContent = 'Copy selector';
      btn.classList.remove('copied');
    }, 2000);
  }).catch(function () {
    // fallback: select the chip text
    const chip = btn.previousElementSibling;
    if (chip) {
      const range = document.createRange();
      range.selectNodeContents(chip);
      const sel2 = window.getSelection();
      sel2.removeAllRanges();
      sel2.addRange(range);
    }
  });
}

// ── Section 1: Active Collections ───────────────────────────────────────────
let ACTIVE_COLLECTIONS = [];

function computeInvStats(inv) {
  var stored    = inv.filter(function (i) {
    return ['stored', 'downloaded', 'stored_embedded'].indexOf(i.pdf_status) !== -1;
  }).length;
  var extracted = inv.filter(function (i) { return i.extracted; }).length;
  var readers   = inv.filter(function (i) { return i.has_reader; }).length;
  return { total: inv.length, stored: stored, extracted: extracted, readers: readers };
}

function renderCollectionCard(c, stats, statusData) {
  var href = 'dashboard.html?collection=' + encodeURIComponent(c.slug);
  var src  = c.source || {};
  var srcLabel = src.library_type === 'group'
    ? 'group ' + src.library_id
    : src.library_type === 'user' ? 'personal library' : '';
  var statusMap = {
    pending:       ['Pending',        'b-pending'],
    synced:        ['Synced',         'b-status'],
    built:         ['Dashboard ready','b-status'],
    readers_ready: ['Readers ready',  'b-status'],
  };
  var sm      = statusMap[c.status] || ['', ''];
  var builtAt = c.built_at ? 'Built ' + c.built_at.slice(0, 10) : '';
  var sel     = buildSelector(src);
  var ancestors  = src.collection_ancestors;
  var breadcrumb = (Array.isArray(ancestors) && ancestors.length)
    ? ancestors.join(' \u203a ') + ' \u203a'
    : '';

  // Live stats from inventory (fall back to num_items from collections.json)
  var itemCount = stats ? stats.total : (c.num_items || 0);
  var statsHtml = '';
  if (stats && stats.total > 0) {
    var parts = [itemCount + ' items'];
    if (stats.stored)    parts.push(stats.stored    + ' PDFs');
    if (stats.extracted) parts.push(stats.extracted + ' extracted');
    if (stats.readers)   parts.push(stats.readers   + ' readers');
    statsHtml = '<div class="card-stats">' + parts.join(' \u00b7 ') + '</div>';
  } else if (itemCount) {
    statsHtml = '<div class="card-stats">' + itemCount + ' items</div>';
  }

  // Scan / import progress status
  var scanHtml = '';
  if (statusData) {
    if (statusData.import_running) {
      var n   = statusData.progress_n     || 0;
      var tot = statusData.progress_total || 0;
      var pct = tot ? Math.round(n / tot * 100) : 0;
      scanHtml = '<div class="card-scan">' +
        '<div class="scan-bar-wrap"><div class="scan-bar-fill" style="width:' + pct + '%"></div></div>' +
        '<span class="scan-bar-text">Fetching PDFs: ' + n + '\u202f/\u202f' + tot + '\u2002(' + pct + '%)</span>' +
        '</div>';
    } else if (!statusData.scan_complete && statusData.last_scan) {
      scanHtml = '<div class="card-scan">Scanning\u2026 (started ' + fmtDate(statusData.last_scan) + ')</div>';
    } else if (statusData.last_scan) {
      scanHtml = '<div class="card-scan">Scanned ' + fmtDate(statusData.last_scan) + '</div>';
    } else {
      scanHtml = '<div class="card-scan scan-needed">Not yet scanned \u2014 run Scan in the dashboard</div>';
    }
  }

  var card = '<a class="collection-card" href="' + esc(href) + '">' +
    (breadcrumb ? '<div class="card-breadcrumb">' + esc(breadcrumb) + '</div>' : '') +
    '<div class="card-name">' + esc(c.name) + '</div>' +
    '<div class="card-desc">' + esc(c.description || '') + '</div>' +
    '<div class="card-badges">' +
      (sm[0]    ? '<span class="badge ' + sm[1] + '">' + esc(sm[0])    + '</span>' : '') +
      (srcLabel ? '<span class="badge b-source">'      + esc(srcLabel) + '</span>' : '') +
    '</div>' +
    statsHtml +
    scanHtml +
    '<div class="card-meta">' +
      (builtAt ? '<span>' + esc(builtAt) + '</span>' : '') +
    '</div>' +
    '<div class="card-arrow">Open dashboard &rarr;</div>' +
  '</a>';

  var resyncBtn = sel
    ? '<button class="btn-resync" onclick="triggerResync(\'' + sel.replace(/'/g, "\\'") + '\', this)" type="button">\u21bb Resync from Zotero</button>'
    : '';

  return '<div class="collection-card-wrap">' + card + resyncBtn + '</div>';
}

fetch('collections.json')
  .then(function (r) { if (!r.ok) throw new Error(r.status); return r.json(); })
  .then(function (data) {
    ACTIVE_COLLECTIONS = data.collections || [];
    document.getElementById('subtitle').textContent =
      ACTIVE_COLLECTIONS.length + ' collection' +
      (ACTIVE_COLLECTIONS.length !== 1 ? 's' : '') + ' available';

    var grid = document.getElementById('grid');

    if (!ACTIVE_COLLECTIONS.length) {
      grid.innerHTML = '<p class="loading-msg">No collections configured yet.</p>';
      loadDiscoverSection();
      return;
    }

    // Show cards immediately with collection metadata (no stats yet)
    grid.innerHTML = ACTIVE_COLLECTIONS.map(function (c) {
      return renderCollectionCard(c, null, null);
    }).join('');

    // Fetch inventory.json + import_status.json per collection in parallel
    var ts = '?_=' + Date.now();
    var fetches = ACTIVE_COLLECTIONS.map(function (c) {
      var base = (c.path === '.' || !c.path) ? '' : c.path + '/';
      var invFetch = fetch(base + 'inventory.json' + ts)
        .then(function (r) { return r.ok ? r.json() : []; })
        .catch(function () { return []; });
      var stFetch  = fetch(base + 'import_status.json' + ts)
        .then(function (r) { return r.ok ? r.json() : null; })
        .catch(function () { return null; });
      return Promise.all([invFetch, stFetch]);
    });

    Promise.all(fetches).then(function (results) {
      grid.innerHTML = ACTIVE_COLLECTIONS.map(function (c, i) {
        return renderCollectionCard(c, computeInvStats(results[i][0]), results[i][1]);
      }).join('');
    });

    loadDiscoverSection();
  })
  .catch(function (err) {
    document.getElementById('grid').innerHTML =
      '<p class="loading-msg">Failed to load collections.json: ' + esc(err.message) + '</p>';
    loadDiscoverSection();
  });

// ── Section 2: Discover More ─────────────────────────────────────────────────

function isActive(libType, libId, collKey) {
  for (var i = 0; i < ACTIVE_COLLECTIONS.length; i++) {
    var s = ACTIVE_COLLECTIONS[i].source || {};
    var ck = s.collection_key || null;
    var cmp = collKey || null;
    if (s.library_type === libType &&
        String(s.library_id) === String(libId) &&
        ck === cmp) {
      return true;
    }
  }
  return false;
}

// ── GitHub API: trigger select-collection workflow directly ──────────────────

function getGithubToken() {
  var token = localStorage.getItem('scholion_gh_pat');
  if (token) return token;
  token = prompt(
    'Enter a GitHub Personal Access Token to trigger workflows.\n\n' +
    'Fine-grained token (recommended):\n' +
    '  github.com/settings/tokens?type=beta\n' +
    '  → Repository access: select this repo\n' +
    '  → Permissions → Actions: Read and write\n\n' +
    'Classic token (simpler):\n' +
    '  github.com/settings/tokens/new\n' +
    '  → Scopes: tick "workflow"\n\n' +
    'The token is stored only in your browser\'s localStorage.'
  );
  if (token && token.trim()) {
    token = token.trim();
    localStorage.setItem('scholion_gh_pat', token);
    return token;
  }
  return null;
}

function clearGithubToken() {
  localStorage.removeItem('scholion_gh_pat');
}

function triggerAdd(selector, btn) {
  if (!GITHUB_URL) { alert('Cannot determine repository URL.'); return; }
  var token = getGithubToken();
  if (!token) return;

  btn.disabled = true;
  btn.textContent = 'Adding\u2026';

  var apiUrl = GITHUB_URL
    .replace('https://github.com/', 'https://api.github.com/repos/') +
    '/actions/workflows/select-collection.yml/dispatches';

  fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Accept': 'application/vnd.github+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ ref: 'main', inputs: { selector: selector } })
  })
  .then(function (r) {
    if (r.status === 204) {
      btn.textContent = '\u2713 Workflow triggered';
      btn.style.color = '#5fba7d';
      btn.style.borderColor = '#2a5a2a';
      // Add a visible notice below the button's card
      var notice = document.createElement('div');
      notice.style.cssText = 'font-size:12px;color:#d4b05a;margin-top:8px;line-height:1.5';
      notice.innerHTML = 'The collection will appear under <strong>Your Collections</strong> after ' +
        'the workflow finishes (~1 min) and GitHub Pages redeploys (~1\u20132 min). ' +
        'Refresh this page in about <strong>2\u20133 minutes</strong>.';
      btn.parentNode.appendChild(notice);
    } else if (r.status === 401) {
      clearGithubToken();
      btn.textContent = '+ Add Collection';
      btn.disabled = false;
      alert('Token rejected (401) \u2014 it may be expired or mistyped. Token cleared; click again to re-enter.');
    } else if (r.status === 403) {
      clearGithubToken();
      btn.textContent = '+ Add Collection';
      btn.disabled = false;
      alert('Permission denied (403).\nEnsure your token has:\n\u2022 Fine-grained: Actions \u2192 Read and write, with this repo selected\n\u2022 Classic: "workflow" scope\nToken cleared; click again to re-enter.');
    } else {
      r.text().then(function (t) {
        btn.textContent = 'Error ' + r.status;
        btn.title = t;
        btn.disabled = false;
      });
    }
  })
  .catch(function () {
    btn.textContent = 'Network error \u2014 click to retry';
    btn.disabled = false;
  });
}

// Reconstruct the selector string from a collection's stored source object.
function buildSelector(src) {
  if (!src || !src.library_type) return null;
  if (src.library_type === 'group')
    return 'G:' + src.library_id + ':' + (src.collection_key || '');
  if (src.library_type === 'user')
    return 'U::' + (src.collection_key || '');
  return null;
}

function triggerResync(selector, btn) {
  if (!GITHUB_URL) { alert('Cannot determine repository URL.'); return; }
  var token = getGithubToken();
  if (!token) return;

  btn.disabled = true;
  btn.textContent = 'Resyncing\u2026';

  var apiUrl = GITHUB_URL
    .replace('https://github.com/', 'https://api.github.com/repos/') +
    '/actions/workflows/select-collection.yml/dispatches';

  fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Accept': 'application/vnd.github+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ ref: 'main', inputs: { selector: selector } })
  })
  .then(function (r) {
    if (r.status === 204) {
      btn.textContent = '\u2713 Resync triggered';
      btn.style.color = '#5fba7d';
      btn.style.borderColor = '#2a5a2a';
      var notice = document.createElement('div');
      notice.style.cssText = 'font-size:11px;color:#d4b05a;margin-top:4px;line-height:1.5';
      notice.innerHTML = 'Collection will update after the workflow finishes (~1 min) and Pages redeploys (~1\u20132 min). ' +
        'Refresh in about <strong>2\u20133 minutes</strong>.';
      btn.parentNode.appendChild(notice);
    } else if (r.status === 401) {
      clearGithubToken();
      btn.textContent = '\u21bb Resync from Zotero';
      btn.disabled = false;
      alert('Token rejected (401) \u2014 it may be expired or mistyped. Token cleared; click again to re-enter.');
    } else if (r.status === 403) {
      clearGithubToken();
      btn.textContent = '\u21bb Resync from Zotero';
      btn.disabled = false;
      alert('Permission denied (403).\nEnsure your token has:\n\u2022 Fine-grained: Actions \u2192 Read and write, with this repo selected\n\u2022 Classic: "workflow" scope\nToken cleared; click again to re-enter.');
    } else {
      r.text().then(function (t) {
        btn.textContent = 'Error ' + r.status + ' \u2014 click to retry';
        btn.title = t;
        btn.disabled = false;
      });
    }
  })
  .catch(function () {
    btn.textContent = 'Network error \u2014 click to retry';
    btn.disabled = false;
  });
}

function renderDiscoverCard(libType, libId, libName, collKey, collName, numItems) {
  const sel = makeSelector(libType, libId, collKey);
  const displayName = collName
    ? esc(collName)
    : esc(libName) + ' <span style="font-size:12px;font-weight:400;color:var(--muted)">(entire library)</span>';
  const srcLabel = libType === 'group'
    ? 'group ' + esc(String(libId))
    : 'personal library';
  const countStr = numItems != null ? numItems + ' items' : '';
  return '<div class="discover-card">' +
    '<div class="card-name">' + displayName + '</div>' +
    '<div class="card-badges" style="margin-top:0">' +
      (srcLabel  ? '<span class="badge b-group">'  + srcLabel  + '</span>' : '') +
      (countStr  ? '<span class="badge b-items">'  + countStr  + '</span>' : '') +
    '</div>' +
    '<div class="selector-row">' +
      '<span class="selector-chip">' + esc(sel) + '</span>' +
      '<button class="btn-copy" onclick="copySelector(this, \'' + sel.replace(/'/g,"\\'") + '\')" type="button">Copy selector</button>' +
      '<button class="btn-add-link" onclick="triggerAdd(\'' + sel.replace(/'/g,"\\'") + '\', this)" type="button">+ Add Collection</button>' +
    '</div>' +
  '</div>';
}

function loadDiscoverSection() {
  const container = document.getElementById('discover-content');

  fetch('discovered_collections.json')
    .then(function (r) {
      if (r.status === 404) {
        // State A: discovery data not available yet
        var discoverLink = GITHUB_URL
          ? '<p style="margin-top:18px"><a class="btn-action" href="' +
            esc(workflowUrl('discover-collections.yml')) +
            '" target="_blank" rel="noopener">&#8599; Run Discover Collections workflow</a></p>'
          : '';
        container.innerHTML =
          '<div class="notice-box">' +
            '<p><strong style="color:#fff">Your Zotero account has not been scanned yet.</strong></p>' +
            '<p style="margin-top:10px">Click the button above (<strong>↗ Discover Collections</strong>) ' +
            'or the button below to scan your Zotero account via GitHub Actions. ' +
            'The workflow reads your <code style="background:#222;padding:1px 5px;border-radius:3px">ZOTERO_API_KEY</code> ' +
            'secret and enumerates every library and collection you have access to.</p>' +
            '<p style="margin-top:10px">After the workflow finishes (~30 s), refresh this page to see ' +
            'all your libraries and collections as cards you can add.</p>' +
            discoverLink +
            '<p style="margin-top:14px;font-size:12px;color:#555">' +
            'If you have not set the <code style="background:#222;padding:1px 5px;border-radius:3px">ZOTERO_API_KEY</code> ' +
            'secret yet, go to your repository &rarr; Settings &rarr; Secrets and variables &rarr; Actions and add it.' +
            '</p>' +
          '</div>';
        return null;
      }
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(function (data) {
      if (!data) return;  // handled above (404)

      // Build cards for unselected items
      var cards = [];
      var libraries = data.libraries || [];

      for (var i = 0; i < libraries.length; i++) {
        var lib = libraries[i];
        var libType = lib.type;
        var libId   = String(lib.id);
        var libName = lib.name || libId;
        var numItems = lib.num_items != null ? lib.num_items : null;

        // Card for the entire library root (collKey = null / empty)
        if (!isActive(libType, libId, null)) {
          cards.push(renderDiscoverCard(libType, libId, libName, null, null, numItems));
        }

        // Cards for each top-level collection (depth 0 = roots with parentKey null)
        var cols = lib.collections || [];
        for (var j = 0; j < cols.length; j++) {
          var col = cols[j];
          if (col.parentKey != null) continue;  // only root-level collections
          if (!isActive(libType, libId, col.key)) {
            cards.push(renderDiscoverCard(
              libType, libId, libName, col.key, col.name, col.numItems
            ));
          }
        }
      }

      if (cards.length === 0) {
        // State C: all discovered collections are already active
        container.innerHTML =
          '<div class="all-active-msg">' +
            '<span style="color:#5fba7d">&#10003;</span> ' +
            'All discovered collections are already active. ' +
            '<a class="btn-action btn-secondary" style="margin-left:8px;font-size:11px;padding:3px 10px" ' +
            'href="' + esc(workflowUrl('discover-collections.yml')) + '" target="_blank" rel="noopener">' +
            '&#8599; Re-run Discover to check for new libraries</a>' +
          '</div>';
      } else {
        // State B: unselected items found
        var total = libraries.reduce(function (s, l) { return s + (l.num_items || 0); }, 0);
        var subtext = cards.length + ' available to add' +
          (total ? ' &mdash; ' + total + ' items across all libraries' : '');
        container.innerHTML =
          '<p class="intro" style="margin-bottom:12px">' + subtext + '</p>' +
          '<div class="collection-grid">' + cards.join('') + '</div>';
      }
    })
    .catch(function (err) {
      container.innerHTML =
        '<p class="loading-msg">Could not load discovery data: ' + esc(err.message) + '</p>';
    });
}
</script>
</body>
</html>
