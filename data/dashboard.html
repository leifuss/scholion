<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Corpus Dashboard</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; font-size: 13px;
         background: #f5f5f7; color: #1d1d1f; }
  header { background: #1c1c1e; color: #fff; padding: 14px 24px;
            display: flex; align-items: center; gap: 20px; }
  header h1 { font-size: 16px; font-weight: 600; }
  header p  { font-size: 12px; color: #98989d; margin-top: 2px; flex: 1; }
  .site-nav { display: flex; gap: 12px; margin-left: auto; }
  .site-nav a { font-size: 12px; color: #98989d; text-decoration: none;
    padding: 4px 10px; border-radius: 6px; border: 1px solid #444;
    transition: color .15s, border-color .15s; }
  .site-nav a:hover { color: #fff; border-color: #888; }
  .site-nav a.active { color: #fff; border-color: #0071e3; }

  .stats { display: flex; gap: 12px; padding: 14px 24px; background: #fff;
            border-bottom: 1px solid #e0e0e5; flex-wrap: wrap; }
  .stat { background: #f5f5f7; border-radius: 8px; padding: 8px 14px; min-width: 100px; }
  .stat .val { font-size: 22px; font-weight: 700; color: #0071e3; }
  .stat .lbl { font-size: 11px; color: #6e6e73; margin-top: 2px; }

  .controls { display: flex; gap: 10px; align-items: center; padding: 10px 24px;
               background: #fff; border-bottom: 1px solid #e0e0e5; flex-wrap: wrap; }
  .controls input  { padding: 6px 10px; border: 1px solid #d2d2d7; border-radius: 6px;
                      font-size: 13px; width: 260px; }
  .controls select { padding: 6px 8px; border: 1px solid #d2d2d7; border-radius: 6px;
                      font-size: 13px; background: #fff; }
  .controls label  { font-size: 12px; color: #6e6e73; }

  .table-wrap { overflow-x: auto; padding: 0 24px 24px; }
  table { border-collapse: collapse; width: 100%; margin-top: 12px;
           background: #fff; border-radius: 10px; overflow: hidden;
           box-shadow: 0 1px 3px rgba(0,0,0,.08); }
  th { background: #f5f5f7; padding: 9px 10px; text-align: left;
        font-size: 12px; font-weight: 600; color: #6e6e73;
        border-bottom: 1px solid #e0e0e5; white-space: nowrap;
        cursor: pointer; user-select: none; position: sticky; top: 0; z-index: 1; }
  th:hover { background: #ebebed; }
  th .sort-arrow { margin-left: 4px; opacity: 0.4; font-size: 10px; }
  th.sort-asc  .sort-arrow { opacity: 1; }
  th.sort-desc .sort-arrow { opacity: 1; }
  td { padding: 7px 10px; border-bottom: 1px solid #f0f0f2; vertical-align: top;
        max-width: 320px; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #fafafa; }

  /* Row colour coding */
  tr.row-stored-emb td:first-child { border-left: 3px solid #34c759; }
  tr.row-stored-scan td:first-child { border-left: 3px solid #ff9f0a; }
  tr.row-url td:first-child  { border-left: 3px solid #636366; }
  tr.row-none td:first-child { border-left: 3px solid #ff3b30; }

  .badge { display: inline-block; padding: 2px 7px; border-radius: 4px;
            font-size: 11px; font-weight: 500; white-space: nowrap; }
  .b-stored    { background: #e8f8ed; color: #1a7f37; }
  .b-url       { background: #f0f0f0; color: #444; }
  .b-missing   { background: #fde8e8; color: #c0392b; }
  .b-embedded  { background: #e8f0fe; color: #1a56db; }
  .b-scanned   { background: #fff3e0; color: #b45309; }
  .b-unknown   { background: #f0f0f0; color: #666; }
  .b-accept    { background: #e8f8ed; color: #1a7f37; }
  .b-arbitrate { background: #fff3e0; color: #b45309; }
  .b-manual    { background: #fde8e8; color: #c0392b; }

  .title-cell { max-width: 300px; }
  .title-cell a { color: #0071e3; text-decoration: none; }
  .title-cell a:hover { text-decoration: underline; }
  .title-text { font-weight: 500; }
  .title-pub  { font-style: italic; font-size: 11px; color: #555; margin-top: 2px; }
  .title-meta { font-size: 11px; color: #999; margin-top: 1px; }
  .key-mono { font-family: monospace; font-size: 11px; color: #bbb; margin-top: 2px; }
  .num { text-align: right; font-variant-numeric: tabular-nums; }
  .hidden { display: none; }

  #count-label { font-size: 12px; color: #6e6e73; }

  .loading { text-align: center; padding: 60px 24px; color: #6e6e73; font-size: 14px; }
</style>
</head>
<body>

<header>
  <div>
    <h1 id="page-title">Corpus Dashboard</h1>
    <p id="subtitle">Loading inventory&hellip;</p>
  </div>
  <nav class="site-nav">
    <a href="index.html" id="navCollections">Collections</a>
    <a id="navDashboard" href="dashboard.html" class="active">Dashboard</a>
    <a id="navExplorer" href="explore.html">Explorer</a>
    <a id="navChat" href="chat.html">Chat</a>
  </nav>
</header>

<div class="stats" id="stats-bar">
  <div class="stat"><div class="val" id="stat-total">&mdash;</div><div class="lbl">Total items</div></div>
  <div class="stat"><div class="val" id="stat-stored">&mdash;</div><div class="lbl">In Zotero</div></div>
  <div class="stat"><div class="val" id="stat-downloaded">&mdash;</div><div class="lbl">Downloaded</div></div>
  <div class="stat"><div class="val" id="stat-url">&mdash;</div><div class="lbl">URL only</div></div>
  <div class="stat"><div class="val" id="stat-none">&mdash;</div><div class="lbl">No attachment</div></div>
  <div class="stat"><div class="val" id="stat-embedded">&mdash;</div><div class="lbl">Embedded fonts</div></div>
  <div class="stat"><div class="val" id="stat-scanned">&mdash;</div><div class="lbl">Scanned</div></div>
  <div class="stat"><div class="val" id="stat-extracted">&mdash;</div><div class="lbl">Text extracted</div></div>
</div>

<div class="controls">
  <input type="text" id="search" placeholder="Search title, author, key…" oninput="filterTable()">
  <label>PDF:
    <select id="filter-pdf" onchange="filterTable()">
      <option value="">All</option>
      <option value="stored">Stored (Zotero)</option>
      <option value="downloaded">Downloaded</option>
      <option value="url_only">URL only</option>
      <option value="no_attachment">No attachment</option>
      <option value="attachment_missing">Missing</option>
    </select>
  </label>
  <label>Type:
    <select id="filter-type" onchange="filterTable()">
      <option value="">All</option>
      <option value="embedded">Embedded</option>
      <option value="scanned">Scanned</option>
      <option value="unknown">Unknown</option>
    </select>
  </label>
  <label>Lang:
    <select id="filter-lang" onchange="filterTable()">
      <option value="">All</option>
    </select>
  </label>
  <label>Extracted:
    <select id="filter-ext" onchange="filterTable()">
      <option value="">All</option>
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>
  </label>
  <span id="count-label"></span>
</div>

<div class="table-wrap">
<table id="main-table">
<thead>
<tr>
  <th data-col="0" onclick="sortTable(0)">#<span class="sort-arrow">&#8597;</span></th>
  <th data-col="1" onclick="sortTable(1)">Key<span class="sort-arrow">&#8597;</span></th>
  <th data-col="2" onclick="sortTable(2)">Title<span class="sort-arrow">&#8597;</span></th>
  <th data-col="3" onclick="sortTable(3)">Year<span class="sort-arrow">&#8597;</span></th>
  <th data-col="4" onclick="sortTable(4)">Authors<span class="sort-arrow">&#8597;</span></th>
  <th data-col="5" onclick="sortTable(5)">Publication<span class="sort-arrow">&#8597;</span></th>
  <th data-col="6" onclick="sortTable(6)">Item Type<span class="sort-arrow">&#8597;</span></th>
  <th data-col="7" onclick="sortTable(7)">PDF Status<span class="sort-arrow">&#8597;</span></th>
  <th data-col="8" onclick="sortTable(8)">Doc Type<span class="sort-arrow">&#8597;</span></th>
  <th data-col="9" onclick="sortTable(9)">Pages<span class="sort-arrow">&#8597;</span></th>
  <th data-col="10" onclick="sortTable(10)">Lang<span class="sort-arrow">&#8597;</span></th>
  <th data-col="11" onclick="sortTable(11)">Quality<span class="sort-arrow">&#8597;</span></th>
  <th data-col="12" onclick="sortTable(12)">Result<span class="sort-arrow">&#8597;</span></th>
</tr>
</thead>
<tbody id="tbody">
  <tr><td colspan="13" class="loading">Loading inventory&hellip;</td></tr>
</tbody>
</table>
</div>

<script>
let DATA = [];

// ── Collection resolution ────────────────────────────────────────────────────
const _urlParams     = new URLSearchParams(location.search);
const _collectionSlug = _urlParams.get('collection') || '';
let   BASE_PATH      = '.';

function collectionQS(prefix) {
  return _collectionSlug ? prefix + 'collection=' + encodeURIComponent(_collectionSlug) : '';
}

(async function resolveCollection() {
  if (_collectionSlug) {
    try {
      const resp = await fetch('collections.json');
      if (resp.ok) {
        const data = await resp.json();
        const coll = (data.collections || []).find(c => c.slug === _collectionSlug);
        if (coll && coll.path) {
          BASE_PATH = coll.path === '.' ? '.' : coll.path;
        }
        if (coll && coll.name) {
          document.getElementById('page-title').textContent = coll.name + ' — Dashboard';
          document.title = coll.name + ' — Corpus Dashboard';
        }
      }
    } catch (e) {
      console.warn('Could not load collections.json, using default path', e);
    }
  }
  // Update nav links to carry the collection param
  const qs = collectionQS('?');
  document.getElementById('navDashboard').href = 'dashboard.html' + qs;
  document.getElementById('navExplorer').href   = 'explore.html' + qs;
  document.getElementById('navChat').href        = 'chat.html' + qs;

  // Load inventory at runtime
  const invUrl = BASE_PATH === '.' ? 'inventory.json' : BASE_PATH + '/inventory.json';
  fetch(invUrl)
    .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
    .then(init)
    .catch(err => {
      document.getElementById('tbody').innerHTML =
        `<tr><td colspan="13" class="loading">Failed to load inventory.json: ${err.message}</td></tr>`;
    });
})();

function init(inventory) {
  DATA = inventory;

  // Subtitle
  document.getElementById('subtitle').textContent = DATA.length + ' items';

  // Summary stats
  const count = (fn) => DATA.filter(fn).length;
  document.getElementById('stat-total').textContent     = DATA.length;
  document.getElementById('stat-stored').textContent     = count(r => r.pdf_status === 'stored');
  document.getElementById('stat-downloaded').textContent = count(r => r.pdf_status === 'downloaded');
  document.getElementById('stat-url').textContent        = count(r => r.pdf_status === 'url_only');
  document.getElementById('stat-none').textContent       = count(r => ['no_attachment','attachment_missing'].includes(r.pdf_status));
  document.getElementById('stat-embedded').textContent   = count(r => r.doc_type === 'embedded');
  document.getElementById('stat-scanned').textContent    = count(r => r.doc_type === 'scanned');
  document.getElementById('stat-extracted').textContent  = count(r => r.extracted);

  // Populate language filter
  const langs = [...new Set(DATA.map(r => r.language).filter(Boolean))].sort();
  const sel   = document.getElementById('filter-lang');
  langs.forEach(l => {
    const o = document.createElement('option');
    o.value = l; o.textContent = l;
    sel.appendChild(o);
  });

  filterTable();
}

// ── Rendering ─────────────────────────────────────────────────────────────────

function pdfBadge(s) {
  if (s === 'stored')             return '<span class="badge b-stored">&#10003; Stored</span>';
  if (s === 'downloaded')         return '<span class="badge b-stored">&#11015; Downloaded</span>';
  if (s === 'url_only')           return '<span class="badge b-url">URL only</span>';
  if (s === 'no_attachment')      return '<span class="badge b-missing">None</span>';
  if (s === 'attachment_missing') return '<span class="badge b-missing">Missing</span>';
  return '<span class="badge b-unknown">' + s + '</span>';
}

function typeBadge(s) {
  if (s === 'embedded') return '<span class="badge b-embedded">Embedded</span>';
  if (s === 'scanned')  return '<span class="badge b-scanned">Scanned</span>';
  return '<span class="badge b-unknown">&mdash;</span>';
}

function recBadge(s) {
  if (!s) return '';
  if (s === 'auto_accept') return '<span class="badge b-accept">Auto &#10003;</span>';
  if (s === 'arbitrate')   return '<span class="badge b-arbitrate">Arbitrate</span>';
  return '<span class="badge b-manual">' + s + '</span>';
}

function rowClass(r) {
  if (['stored','downloaded'].includes(r.pdf_status) && r.doc_type === 'embedded') return 'row-stored-emb';
  if (['stored','downloaded'].includes(r.pdf_status) && r.doc_type === 'scanned')  return 'row-stored-scan';
  if (r.pdf_status === 'url_only') return 'row-url';
  return 'row-none';
}

function titleCell(r) {
  const key     = '<div class="key-mono">' + r.key + '</div>';
  const titleEl = '<div class="title-text">' + escHtml(r.title) + '</div>';
  const pubEl   = r.pub_title ? '<div class="title-pub">' + escHtml(r.pub_title) + '</div>' : '';
  const metaParts = [r.authors, r.year, r.place].filter(Boolean);
  const metaEl  = metaParts.length ? '<div class="title-meta">' + escHtml(metaParts.join(' \u00b7 ')) + '</div>' : '';
  if (r.url) {
    return '<div class="title-cell"><a href="' + escHtml(r.url) + '" target="_blank">' + titleEl + '</a>' + pubEl + metaEl + key + '</div>';
  }
  return '<div class="title-cell">' + titleEl + pubEl + metaEl + key + '</div>';
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderRow(r, idx) {
  const q = r.quality_score !== null && r.quality_score !== undefined
            ? r.quality_score.toFixed(2) : '\u2014';
  return `<tr class="${rowClass(r)}" data-idx="${idx}">
    <td class="num">${idx+1}</td>
    <td class="key-mono">${escHtml(r.key)}</td>
    <td>${titleCell(r)}</td>
    <td>${escHtml(r.year)}</td>
    <td>${escHtml(r.authors)}</td>
    <td style="max-width:200px;font-style:italic;color:#444">${escHtml(r.pub_title||'\u2014')}</td>
    <td>${escHtml(r.item_type)}</td>
    <td>${pdfBadge(r.pdf_status)}</td>
    <td>${typeBadge(r.doc_type)}</td>
    <td class="num">${r.page_count !== null && r.page_count !== undefined ? r.page_count : '\u2014'}</td>
    <td>${escHtml(r.language||'\u2014')}</td>
    <td class="num">${q}</td>
    <td>${recBadge(r.recommendation)}</td>
  </tr>`;
}

// ── Filter & render ───────────────────────────────────────────────────────────
let currentData = [];
let sortCol     = -1;
let sortAsc     = true;

function filterTable() {
  const q    = document.getElementById('search').value.toLowerCase();
  const pdf  = document.getElementById('filter-pdf').value;
  const type = document.getElementById('filter-type').value;
  const lang = document.getElementById('filter-lang').value;
  const ext  = document.getElementById('filter-ext').value;

  currentData = DATA.filter(r => {
    if (q && !(
      (r.title  ||'').toLowerCase().includes(q) ||
      (r.authors||'').toLowerCase().includes(q) ||
      (r.key    ||'').toLowerCase().includes(q)
    )) return false;
    if (pdf  && r.pdf_status !== pdf)  return false;
    if (type && r.doc_type   !== type) return false;
    if (lang && r.language   !== lang) return false;
    if (ext  === 'yes' && !r.extracted) return false;
    if (ext  === 'no'  &&  r.extracted) return false;
    return true;
  });

  if (sortCol >= 0) applySort();
  else renderTable();
}

function renderTable() {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = currentData.map((r, i) => renderRow(r, i)).join('');
  document.getElementById('count-label').textContent =
    currentData.length + ' of ' + DATA.length + ' items';
}

// ── Sort ──────────────────────────────────────────────────────────────────────
const COL_KEYS = ['_idx','key','title','year','authors','pub_title','item_type',
                  'pdf_status','doc_type','page_count','language','quality_score','recommendation'];

function sortTable(col) {
  if (sortCol === col) { sortAsc = !sortAsc; }
  else { sortCol = col; sortAsc = true; }

  document.querySelectorAll('th').forEach((th, i) => {
    th.classList.remove('sort-asc','sort-desc');
    if (i === col) th.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');
    const arr = th.querySelector('.sort-arrow');
    if (arr) arr.textContent = i === col ? (sortAsc ? '\u2191' : '\u2193') : '\u2195';
  });
  applySort();
}

function applySort() {
  const key = COL_KEYS[sortCol];
  currentData.sort((a, b) => {
    let va = key === '_idx' ? DATA.indexOf(a) : (a[key] ?? '');
    let vb = key === '_idx' ? DATA.indexOf(b) : (b[key] ?? '');
    if (va === null || va === undefined || va === '') va = sortAsc ? Infinity : -Infinity;
    if (vb === null || vb === undefined || vb === '') vb = sortAsc ? Infinity : -Infinity;
    if (typeof va === 'number' && typeof vb === 'number') return sortAsc ? va - vb : vb - va;
    return sortAsc
      ? String(va).localeCompare(String(vb))
      : String(vb).localeCompare(String(va));
  });
  renderTable();
}
</script>
</body>
</html>
