<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Corpus Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,600;1,400&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; font-size: 13px;
         background: #f5f5f7; color: #1d1d1f; }
  header { background: #1c1c1e; color: #fff; padding: 14px 24px;
            display: flex; align-items: center; gap: 16px; }
  .scholion-logo {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 20px; font-weight: 600; color: #fff;
    letter-spacing: .04em; text-decoration: none; line-height: 1; flex-shrink: 0;
  }
  .scholion-logo:hover { color: #ccc; }
  .header-divider { color: #555; font-size: 14px; flex-shrink: 0; }
  header h1 { font-size: 16px; font-weight: 600; }
  header p  { font-size: 12px; color: #98989d; margin-top: 2px; flex: 1; }
  .site-nav { display: flex; gap: 12px; margin-left: auto; }
  .site-nav a { font-size: 12px; color: #98989d; text-decoration: none;
    padding: 4px 10px; border-radius: 6px; border: 1px solid #444;
    transition: color .15s, border-color .15s; }
  .site-nav a:hover { color: #fff; border-color: #888; }
  .site-nav a.active { color: #fff; border-color: #0071e3; }

  /* Donut charts stats bar */
  .stats { display: flex; gap: 24px; padding: 16px 24px; background: #fff;
            border-bottom: 1px solid #e0e0e5; flex-wrap: wrap; align-items: flex-start; }
  .donut-block { display: flex; align-items: center; gap: 12px; }
  .donut-block svg { flex-shrink: 0; }
  .donut-legend { display: flex; flex-direction: column; gap: 3px; }
  .donut-legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #444; }
  .donut-legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .donut-legend-count { font-weight: 600; color: #1d1d1f; min-width: 20px; text-align: right; }
  .donut-title { font-size: 10px; font-weight: 600; color: #6e6e73; text-transform: uppercase;
                  letter-spacing: .04em; margin-bottom: 2px; }
  .scan-note { font-size: 11px; color: #6e6e73; margin-left: auto; align-self: center; }

  .controls { display: flex; gap: 10px; align-items: center; padding: 10px 24px;
               background: #fff; border-bottom: 1px solid #e0e0e5; flex-wrap: wrap; }
  .controls input  { padding: 6px 10px; border: 1px solid #d2d2d7; border-radius: 6px;
                      font-size: 13px; width: 260px; }
  .controls select { padding: 6px 8px; border: 1px solid #d2d2d7; border-radius: 6px;
                      font-size: 13px; background: #fff; }
  .controls label  { font-size: 12px; color: #6e6e73; }

  .table-wrap { overflow-x: auto; padding: 0 24px 24px; }
  table { border-collapse: collapse; width: 100%; margin-top: 12px;
           background: #fff; border-radius: 10px; overflow: hidden;
           box-shadow: 0 1px 3px rgba(0,0,0,.08); table-layout: fixed; }
  th { background: #f5f5f7; padding: 9px 10px; text-align: left;
        font-size: 12px; font-weight: 600; color: #6e6e73;
        border-bottom: 1px solid #e0e0e5; white-space: nowrap;
        cursor: pointer; user-select: none; position: sticky; top: 0; z-index: 1; }
  th:hover { background: #ebebed; }
  th .sort-arrow { margin-left: 4px; opacity: 0.4; font-size: 10px; }
  th.sort-asc  .sort-arrow { opacity: 1; }
  th.sort-desc .sort-arrow { opacity: 1; }
  td { padding: 7px 10px; border-bottom: 1px solid #f0f0f2; vertical-align: middle;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #fafafa; }
  tr[data-key] { cursor: pointer; }

  .col-title   { width: 38%; }
  .col-year    { width: 55px; }
  .col-authors { width: 15%; }
  .col-pdf     { width: 90px; }
  .col-avail   { width: 90px; }
  .col-type    { width: 80px; }
  .col-pp      { width: 55px; }
  .col-lang    { width: 45px; }
  .col-action  { width: 95px; }

  tr.row-stored-emb td:first-child { border-left: 3px solid #34c759; }
  tr.row-stored-scan td:first-child { border-left: 3px solid #ff9f0a; }
  tr.row-url td:first-child  { border-left: 3px solid #636366; }
  tr.row-none td:first-child { border-left: 3px solid #ff3b30; }

  .badge { display: inline-block; padding: 2px 7px; border-radius: 4px;
            font-size: 11px; font-weight: 500; white-space: nowrap; }
  .b-stored    { background: #e8f8ed; color: #1a7f37; }
  .b-url       { background: #f0f0f0; color: #444; }
  .b-missing   { background: #fde8e8; color: #c0392b; }
  .b-embedded  { background: #e8f0fe; color: #1a56db; }
  .b-scanned   { background: #fff3e0; color: #b45309; }
  .b-unknown   { background: #f0f0f0; color: #666; }
  .b-accept    { background: #e8f8ed; color: #1a7f37; }
  .b-arbitrate { background: #fff3e0; color: #b45309; }
  .b-manual    { background: #fde8e8; color: #c0392b; }
  .b-oa        { background: #e8f8ed; color: #1a7f37; }
  .b-paywalled { background: #fff3e0; color: #b45309; }
  .b-unavail   { background: #fde8e8; color: #c0392b; }
  .b-not-scanned { background: #f0f0f0; color: #999; }
  .b-good      { background: #e8f8ed; color: #1a7f37; }
  .b-suspect   { background: #fff3e0; color: #b45309; }
  .b-garbled   { background: #fde8e8; color: #c0392b; }
  .b-lang      { background: #eef; color: #336; }
  .b-itype     { background: #f0f0f0; color: #555; }
  .b-tag       { background: #f0f0f0; color: #555; }

  .title-text { font-weight: 500; overflow: hidden; text-overflow: ellipsis; }
  .num { text-align: right; font-variant-numeric: tabular-nums; }
  .hidden { display: none; }
  #count-label { font-size: 12px; color: #6e6e73; }
  .loading { text-align: center; padding: 60px 24px; color: #6e6e73; font-size: 14px; }

  .actions-bar {
    display: flex; gap: 8px; align-items: center;
    padding: 8px 24px; background: #fff;
    border-bottom: 1px solid #e0e0e5; flex-wrap: wrap;
  }
  .actions-label { font-size: 11px; color: #6e6e73; font-weight: 500;
                   text-transform: uppercase; letter-spacing: .05em; }
  .btn-workflow {
    padding: 5px 13px; border-radius: 6px; font-size: 12px; font-weight: 500;
    cursor: pointer; border: 1px solid #d2d2d7; background: #f5f5f7;
    color: #1d1d1f; transition: background .15s, border-color .15s, color .15s;
  }
  .btn-workflow:hover:not(:disabled) { background: #e8e8ed; border-color: #0071e3; color: #0071e3; }
  .btn-workflow:disabled { opacity: .5; cursor: default; }
  .btn-row-extract {
    padding: 2px 7px; border-radius: 5px; font-size: 11px; font-weight: 500;
    cursor: pointer; border: 1px solid #d2d2d7; background: #f5f5f7;
    color: #555; white-space: nowrap;
    transition: background .15s, border-color .15s, color .15s;
  }
  .btn-row-extract:hover:not(:disabled) { background: #e8e8ed; border-color: #0071e3; color: #0071e3; }
  .btn-row-extract:disabled { opacity: .45; cursor: default; }
  .actions-gh-link {
    font-size: 11px; color: #0071e3; text-decoration: none; margin-left: 4px; display: none;
  }
  .actions-gh-link:hover { text-decoration: underline; }
  .actions-note { font-size: 11px; color: #6e6e73; }

  /* Side panel */
  #doc-info-panel {
    position: fixed; top: 0; right: -440px; width: 440px; height: 100vh;
    background: #fff; border-left: 1px solid #d2d2d7;
    z-index: 2000; display: flex; flex-direction: column;
    transition: right .25s ease;
    box-shadow: -4px 0 20px rgba(0,0,0,.12);
  }
  #doc-info-panel.open { right: 0; }
  .dip-header {
    display: flex; align-items: center; gap: 10px;
    padding: 14px 20px; border-bottom: 1px solid #e0e0e5;
    background: #f5f5f7; flex-shrink: 0;
  }
  .dip-header h2 { font-size: 14px; color: #1d1d1f; flex: 1; font-weight: 600; }
  .dip-close {
    background: none; border: none; color: #6e6e73; font-size: 18px;
    cursor: pointer; padding: 0 4px; line-height: 1;
  }
  .dip-close:hover { color: #1d1d1f; }
  .dip-body { flex: 1; overflow-y: auto; padding: 20px; }
  .dip-title { font-size: 16px; font-weight: 600; color: #1d1d1f; line-height: 1.4; margin-bottom: 8px; }
  .dip-title a { color: #0071e3; text-decoration: none; }
  .dip-title a:hover { text-decoration: underline; }
  .dip-pub { font-size: 12px; font-style: italic; color: #6e6e73; margin-bottom: 14px; }
  .dip-badges { display: flex; gap: 4px; flex-wrap: wrap; margin: 12px 0; }
  .dip-section {
    font-size: 11px; font-weight: 700; color: #6e6e73; text-transform: uppercase;
    letter-spacing: .04em; margin: 16px 0 6px; padding-top: 10px;
    border-top: 1px solid #e0e0e5;
  }
  .dip-row { display: flex; gap: 10px; padding: 6px 0; border-bottom: 1px solid #f0f0f2; font-size: 12px; }
  .dip-row:last-child { border-bottom: none; }
  .dip-label { min-width: 90px; color: #6e6e73; font-weight: 600; flex-shrink: 0; }
  .dip-value { color: #1d1d1f; flex: 1; word-break: break-word; }
  .dip-value a { color: #0071e3; }
  .dip-abstract { font-size: 13px; color: #444; line-height: 1.6; margin: 6px 0; }
  .dip-notes {
    font-size: 12px; color: #666; line-height: 1.5; margin-bottom: 6px;
    padding: 8px 10px; background: #f5f5f7; border-radius: 4px; border-left: 3px solid #d2d2d7;
  }
  .dip-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
  .dip-actions {
    display: flex; gap: 8px; margin-top: 16px; padding-top: 12px; border-top: 1px solid #e0e0e5;
  }
  .dip-actions a, .dip-actions button {
    font-size: 12px; padding: 6px 14px; border-radius: 6px;
    background: #0071e3; color: #fff; text-decoration: none; border: none; cursor: pointer;
    transition: filter .15s;
  }
  .dip-actions a:hover, .dip-actions button:hover { filter: brightness(1.1); }
  .dip-actions .secondary { background: #f5f5f7; border: 1px solid #d2d2d7; color: #1d1d1f; }
  .field-info { font-size: 9px; color: #aaa; cursor: help; margin-left: 2px; vertical-align: super; }
  #doc-info-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.2);
    z-index: 1999; display: none;
  }
  #doc-info-overlay.open { display: block; }
</style>
</head>
<body>

<header>
  <a href="index.html" class="scholion-logo">Scholion</a>
  <span class="header-divider">&middot;</span>
  <div>
    <h1 id="page-title">Corpus Dashboard</h1>
    <p id="subtitle">Loading inventory&hellip;</p>
  </div>
  <nav class="site-nav">
    <a href="index.html" id="navCollections">Collections</a>
    <a id="navDashboard" href="dashboard.html" class="active">Dashboard</a>
    <a id="navExplorer" href="explore.html">Explorer</a>
    <a id="navChat" href="chat.html">Chat</a>
  </nav>
</header>

<div class="stats" id="stats-bar">
  <div id="donut-pdf" class="donut-block"></div>
  <div id="donut-doctype" class="donut-block"></div>
  <div id="donut-access" class="donut-block"></div>
  <span class="scan-note" id="scan-note"></span>
</div>

<div class="actions-bar">
  <span class="actions-label">Run</span>
  <button class="btn-workflow" id="btnScan"
    onclick="triggerWorkflow('import-scan.yml', {collection_slug: _collectionSlug}, this, 'Resync started')">
    &#8634; Resync collection
  </button>
  <button class="btn-workflow" id="btnFetch"
    onclick="triggerWorkflow('import-pdfs.yml', {collection_slug: _collectionSlug, mode: 'available'}, this, 'PDF fetch started')">
    &#8595; Fetch PDFs
  </button>
  <button class="btn-workflow" id="btnExtract"
    onclick="triggerWorkflow('extract.yml', {collection_slug: _collectionSlug}, this, 'Extraction started')">
    &#11045; Extract text
  </button>
  <a class="actions-gh-link" id="actionsGhLink" target="_blank">View in Actions &rarr;</a>
  <span class="actions-note" id="actionsNote"></span>
</div>

<div class="controls">
  <input type="text" id="search" placeholder="Search title, author, key&hellip;" oninput="filterTable()">
  <label>PDF:
    <select id="filter-pdf" onchange="filterTable()">
      <option value="">All</option>
      <option value="stored">Stored (Zotero)</option>
      <option value="downloaded">Downloaded</option>
      <option value="url_only">URL only</option>
      <option value="no_attachment">No attachment</option>
      <option value="attachment_missing">Missing</option>
    </select>
  </label>
  <label>Type:
    <select id="filter-type" onchange="filterTable()">
      <option value="">All</option>
      <option value="embedded">Embedded</option>
      <option value="scanned">Scanned</option>
      <option value="unknown">Unknown</option>
    </select>
  </label>
  <label>Lang:
    <select id="filter-lang" onchange="filterTable()">
      <option value="">All</option>
    </select>
  </label>
  <label>Availability:
    <select id="filter-avail" onchange="filterTable()">
      <option value="">All</option>
      <option value="open_access">Open access</option>
      <option value="restricted">Paywalled</option>
      <option value="unavailable">Unavailable</option>
      <option value="stored">Stored locally</option>
    </select>
  </label>
  <label>Extracted:
    <select id="filter-ext" onchange="filterTable()">
      <option value="">All</option>
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>
  </label>
  <span id="count-label"></span>
</div>

<div class="table-wrap">
<table id="main-table">
<thead>
<tr>
  <th class="col-title"   data-col="0" onclick="sortTable(0)">Title<span class="sort-arrow">&#8597;</span></th>
  <th class="col-year"    data-col="1" onclick="sortTable(1)">Year<span class="sort-arrow">&#8597;</span></th>
  <th class="col-authors" data-col="2" onclick="sortTable(2)">Authors<span class="sort-arrow">&#8597;</span></th>
  <th class="col-pdf"     data-col="3" onclick="sortTable(3)">PDF<span class="sort-arrow">&#8597;</span></th>
  <th class="col-avail"   data-col="4" onclick="sortTable(4)">Avail<span class="sort-arrow">&#8597;</span></th>
  <th class="col-type"    data-col="5" onclick="sortTable(5)">Type<span class="sort-arrow">&#8597;</span></th>
  <th class="col-pp"      data-col="6" onclick="sortTable(6)">pp<span class="sort-arrow">&#8597;</span></th>
  <th class="col-lang"    data-col="7" onclick="sortTable(7)">Lang<span class="sort-arrow">&#8597;</span></th>
  <th class="col-action"  style="cursor:default"></th>
</tr>
</thead>
<tbody id="tbody">
  <tr><td colspan="9" class="loading">Loading inventory&hellip;</td></tr>
</tbody>
</table>
</div>

<div id="doc-info-overlay" onclick="closeDocInfo()"></div>
<div id="doc-info-panel">
  <div class="dip-header">
    <h2 id="dip-heading">Item details</h2>
    <button class="dip-close" onclick="closeDocInfo()">&times;</button>
  </div>
  <div class="dip-body" id="dip-body"></div>
</div>

<script>
let DATA = [];
const _urlParams      = new URLSearchParams(location.search);
const _collectionSlug = _urlParams.get('collection') || '';
let   BASE_PATH       = '.';

function collectionQS(prefix) {
  return _collectionSlug ? prefix + 'collection=' + encodeURIComponent(_collectionSlug) : '';
}

(async function resolveCollection() {
  if (_collectionSlug) {
    try {
      const resp = await fetch('collections.json');
      if (resp.ok) {
        const data = await resp.json();
        const coll = (data.collections || []).find(c => c.slug === _collectionSlug);
        if (coll && coll.path) BASE_PATH = coll.path === '.' ? '.' : coll.path;
        if (coll && coll.name) {
          document.getElementById('page-title').textContent = coll.name + ' \u2014 Dashboard';
          document.title = coll.name + ' \u2014 Corpus Dashboard';
        }
      }
    } catch (e) { console.warn('Could not load collections.json', e); }
  }
  var qs = collectionQS('?');
  document.getElementById('navDashboard').href = 'dashboard.html' + qs;
  document.getElementById('navExplorer').href   = 'explore.html' + qs;
  document.getElementById('navChat').href        = 'chat.html' + qs;

  var invUrl    = BASE_PATH === '.' ? 'inventory.json'     : BASE_PATH + '/inventory.json';
  var statusUrl = BASE_PATH === '.' ? 'import_status.json' : BASE_PATH + '/import_status.json';
  Promise.all([
    fetch(invUrl).then(function(r){ if(!r.ok) throw new Error(r.status); return r.json(); }),
    fetch(statusUrl).then(function(r){ return r.ok ? r.json() : null; }).catch(function(){ return null; }),
  ])
    .then(function(arr){ init(arr[0], arr[1]); })
    .catch(function(err){
      document.getElementById('tbody').innerHTML =
        '<tr><td colspan="9" class="loading">Failed to load inventory.json: '+err.message+'</td></tr>';
    });
})();

function fmtDate(iso) {
  if (!iso) return '';
  try {
    var d = new Date(iso);
    return d.toLocaleDateString(undefined,{day:'numeric',month:'short',year:'numeric'})
           +' '+d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
  } catch(e){ return iso; }
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ---- Donut chart ---- */
function makeDonut(title, segments) {
  var total = 0;
  for (var i=0;i<segments.length;i++) total += segments[i].count;
  if (!total) return '';
  var size=80,cx=40,cy=40,r=30,sw=12;
  var h = '<div class="donut-block"><div><div class="donut-title">'+escHtml(title)+'</div>';
  h += '<svg width="'+size+'" height="'+size+'" viewBox="0 0 '+size+' '+size+'">';
  h += '<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="none" stroke="#eee" stroke-width="'+sw+'"/>';
  var cum = -Math.PI/2;
  for (var i=0;i<segments.length;i++) {
    var seg=segments[i];
    if (!seg.count) continue;
    var frac=seg.count/total, sa=cum, ea=cum+frac*2*Math.PI;
    cum=ea;
    if (frac>=0.9999) {
      h+='<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="none" stroke="'+seg.color+'" stroke-width="'+sw+'"/>';
    } else {
      var x1=cx+r*Math.cos(sa),y1=cy+r*Math.sin(sa),x2=cx+r*Math.cos(ea),y2=cy+r*Math.sin(ea);
      var lg=frac>0.5?1:0;
      h+='<path d="M '+x1+' '+y1+' A '+r+' '+r+' 0 '+lg+' 1 '+x2+' '+y2+'" fill="none" stroke="'+seg.color+'" stroke-width="'+sw+'"/>';
    }
  }
  h+='<text x="'+cx+'" y="'+(cy+1)+'" text-anchor="middle" dominant-baseline="central" fill="#1d1d1f" font-size="14" font-weight="700">'+total+'</text>';
  h+='</svg></div><div class="donut-legend">';
  for (var i=0;i<segments.length;i++) {
    var seg=segments[i];
    if (!seg.count) continue;
    h+='<div class="donut-legend-item"><span class="donut-legend-dot" style="background:'+seg.color+'"></span><span class="donut-legend-count">'+seg.count+'</span> '+escHtml(seg.label)+'</div>';
  }
  h+='</div></div>';
  return h;
}

function renderDonuts(data) {
  var cnt=function(fn){var n=0;for(var i=0;i<data.length;i++) if(fn(data[i])) n++;return n;};
  document.getElementById('donut-pdf').innerHTML = makeDonut('PDF Coverage',[
    {label:'Stored',count:cnt(function(r){return r.pdf_status==='stored'}),color:'#34c759'},
    {label:'Downloaded',count:cnt(function(r){return r.pdf_status==='downloaded'}),color:'#30b0c7'},
    {label:'URL only',count:cnt(function(r){return r.pdf_status==='url_only'}),color:'#8e8e93'},
    {label:'No PDF',count:cnt(function(r){return r.pdf_status==='no_attachment'||r.pdf_status==='attachment_missing'}),color:'#ff3b30'},
  ]);
  document.getElementById('donut-doctype').innerHTML = makeDonut('Doc Type',[
    {label:'Embedded',count:cnt(function(r){return r.doc_type==='embedded'}),color:'#0071e3'},
    {label:'Scanned',count:cnt(function(r){return r.doc_type==='scanned'}),color:'#af52de'},
    {label:'Unknown',count:cnt(function(r){return r.doc_type!=='embedded'&&r.doc_type!=='scanned'}),color:'#d1d1d6'},
  ]);
  var hasAvail=false;
  for(var i=0;i<data.length;i++) if(data[i]._availability){hasAvail=true;break;}
  if (hasAvail) {
    document.getElementById('donut-access').innerHTML = makeDonut('Access',[
      {label:'Open access',count:cnt(function(r){return r._availability==='open_access'}),color:'#34c759'},
      {label:'Paywalled',count:cnt(function(r){return r._availability==='restricted'||r._availability==='unknown'}),color:'#ff9f0a'},
      {label:'Unavailable',count:cnt(function(r){return r._availability==='unavailable'}),color:'#ff3b30'},
      {label:'Stored',count:cnt(function(r){return r._availability==='stored'}),color:'#30b0c7'},
    ]);
  }
}

function init(inventory, statusData) {
  DATA = inventory;
  var scanItems = (statusData && statusData.items) || {};
  DATA.forEach(function(r){
    var si = scanItems[r.key];
    r._availability  = (si && si.availability)  || null;
    r._import_status = (si && si.import_status) || null;
    r._scan_updated  = (si && si.last_updated)  || null;
  });
  var lastScan    = statusData && statusData.last_scan;
  var scanRunning = statusData && statusData.import_running;
  var scanDone    = statusData && statusData.scan_complete;
  document.getElementById('subtitle').textContent = DATA.length + ' items';
  var note = document.getElementById('scan-note');
  if (note) {
    if (scanRunning)   note.textContent = '\u27f3 Scan in progress\u2026';
    else if (lastScan) note.textContent = 'Scanned ' + fmtDate(lastScan) + (scanDone ? '' : ' (incomplete)');
    else               note.textContent = 'Not yet scanned';
  }
  renderDonuts(DATA);
  var langs = [];
  var seen = {};
  DATA.forEach(function(r){ if(r.language && !seen[r.language]){seen[r.language]=1;langs.push(r.language);} });
  langs.sort();
  var sel = document.getElementById('filter-lang');
  langs.forEach(function(l){ var o=document.createElement('option');o.value=l;o.textContent=l;sel.appendChild(o); });
  filterTable();
}

/* ---- Badge helpers ---- */
function pdfBadge(s) {
  if (s==='stored')             return '<span class="badge b-stored">&#10003; Stored</span>';
  if (s==='downloaded')         return '<span class="badge b-stored">&#11015; Downloaded</span>';
  if (s==='url_only')           return '<span class="badge b-url">URL only</span>';
  if (s==='no_attachment')      return '<span class="badge b-missing">None</span>';
  if (s==='attachment_missing') return '<span class="badge b-missing">Missing</span>';
  return '<span class="badge b-unknown">'+escHtml(s)+'</span>';
}
function typeBadge(s) {
  if (s==='embedded') return '<span class="badge b-embedded">Embedded</span>';
  if (s==='scanned')  return '<span class="badge b-scanned">Scanned</span>';
  return '<span class="badge b-unknown">&mdash;</span>';
}
function availBadge(s) {
  if (s==='open_access') return '<span class="badge b-oa">Open access</span>';
  if (s==='restricted'||s==='unknown') return '<span class="badge b-paywalled">Paywalled</span>';
  if (s==='unavailable') return '<span class="badge b-unavail">Unavailable</span>';
  if (s==='stored')      return '<span class="badge b-stored">Stored</span>';
  return '<span class="badge b-not-scanned">&mdash;</span>';
}
function qualityBadge(s) {
  if (s==='good')    return '<span class="badge b-good">&#10003; good</span>';
  if (s==='suspect') return '<span class="badge b-suspect">&#9888; suspect</span>';
  if (s==='garbled') return '<span class="badge b-garbled">&#10007; garbled</span>';
  return '';
}
function recBadge(s) {
  if (!s) return '';
  if (s==='auto_accept') return '<span class="badge b-accept">Auto &#10003;</span>';
  if (s==='arbitrate')   return '<span class="badge b-arbitrate">Arbitrate</span>';
  return '<span class="badge b-manual">'+escHtml(s)+'</span>';
}
function rowClass(r) {
  if ((r.pdf_status==='stored'||r.pdf_status==='downloaded')&&r.doc_type==='embedded') return 'row-stored-emb';
  if ((r.pdf_status==='stored'||r.pdf_status==='downloaded')&&r.doc_type==='scanned')  return 'row-stored-scan';
  if (r.pdf_status==='url_only') return 'row-url';
  return 'row-none';
}
function shortAuthors(s) {
  if (!s) return '\u2014';
  var parts = s.split(';');
  if (parts.length <= 1) return escHtml(s);
  return escHtml(parts[0].trim()) + ' <span style="color:#999">et al.</span>';
}

function renderRow(r, idx) {
  var hasPdf = r.pdf_status==='stored'||r.pdf_status==='downloaded';
  var btn = hasPdf
    ? '<button class="btn-row-extract" title="Force re-extraction" onclick="event.stopPropagation();triggerWorkflow(\'extract.yml\',{collection_slug:_collectionSlug,keys:\''+r.key+'\',run_layout:\'true\',force_layout:\'true\'},this,\'Re-extract started\')">\u21ba Extract</button>'
    : '<button class="btn-row-extract" disabled title="No PDF">\u21ba Extract</button>';
  return '<tr class="'+rowClass(r)+'" data-key="'+r.key+'" data-idx="'+idx+'" onclick="showDocInfo(\''+r.key+'\')">'
    +'<td class="title-text">'+escHtml(r.title)+'</td>'
    +'<td>'+escHtml(r.year)+'</td>'
    +'<td>'+shortAuthors(r.authors)+'</td>'
    +'<td>'+pdfBadge(r.pdf_status)+'</td>'
    +'<td>'+availBadge(r._availability)+'</td>'
    +'<td>'+typeBadge(r.doc_type)+'</td>'
    +'<td class="num">'+(r.page_count!=null?r.page_count:'\u2014')+'</td>'
    +'<td>'+escHtml(r.language||'\u2014')+'</td>'
    +'<td style="white-space:nowrap">'+btn+'</td>'
    +'</tr>';
}

/* ---- Filter & render ---- */
var currentData = [];
var sortCol = -1;
var sortAsc = true;

function filterTable() {
  var q     = document.getElementById('search').value.toLowerCase();
  var pdf   = document.getElementById('filter-pdf').value;
  var type  = document.getElementById('filter-type').value;
  var lang  = document.getElementById('filter-lang').value;
  var avail = document.getElementById('filter-avail').value;
  var ext   = document.getElementById('filter-ext').value;
  currentData = DATA.filter(function(r){
    if (q && !((r.title||'').toLowerCase().indexOf(q)>=0||(r.authors||'').toLowerCase().indexOf(q)>=0||(r.key||'').toLowerCase().indexOf(q)>=0)) return false;
    if (pdf  && r.pdf_status !== pdf)  return false;
    if (type && r.doc_type   !== type) return false;
    if (lang && r.language   !== lang) return false;
    if (avail) {
      if (r._availability!==avail && !(avail==='restricted'&&r._availability==='unknown')) return false;
    }
    if (ext==='yes' && !r.extracted) return false;
    if (ext==='no'  &&  r.extracted) return false;
    return true;
  });
  if (sortCol>=0) applySort(); else renderTable();
}

function renderTable() {
  document.getElementById('tbody').innerHTML = currentData.map(function(r,i){return renderRow(r,i);}).join('');
  document.getElementById('count-label').textContent = currentData.length+' of '+DATA.length+' items';
}

/* ---- Sort ---- */
var COL_KEYS = ['title','year','authors','pdf_status','_availability','doc_type','page_count','language'];

function sortTable(col) {
  if (sortCol===col) sortAsc=!sortAsc; else { sortCol=col; sortAsc=true; }
  document.querySelectorAll('th[data-col]').forEach(function(th){
    var i=parseInt(th.dataset.col);
    th.classList.remove('sort-asc','sort-desc');
    if (i===col) th.classList.add(sortAsc?'sort-asc':'sort-desc');
    var arr=th.querySelector('.sort-arrow');
    if (arr) arr.textContent = i===col ? (sortAsc?'\u2191':'\u2193') : '\u2195';
  });
  applySort();
}

function applySort() {
  var key = COL_KEYS[sortCol];
  currentData.sort(function(a,b){
    var va=a[key]!=null?a[key]:'', vb=b[key]!=null?b[key]:'';
    if (va===''||va===null) va=sortAsc?Infinity:-Infinity;
    if (vb===''||vb===null) vb=sortAsc?Infinity:-Infinity;
    if (typeof va==='number'&&typeof vb==='number') return sortAsc?va-vb:vb-va;
    return sortAsc?String(va).localeCompare(String(vb)):String(vb).localeCompare(String(va));
  });
  renderTable();
}

/* ---- Side panel ---- */
var FIELD_TIPS = {
  'Key':'Zotero item key \u2014 unique identifier for this record',
  'Item Type':'Zotero item type (journalArticle, bookSection, book, \u2026)',
  'Publication':'Journal, book series, or conference name',
  'Publisher':'Publisher name, from Zotero metadata',
  'Place':'Place of publication, from Zotero metadata',
  'Year':'Year of publication',
  'Authors':'Author(s), from Zotero metadata',
  'Pages':'Page range within the publication (e.g. 1\u201315), from Zotero; often blank',
  'PDF pages':'Number of pages in the downloaded PDF',
  'Language':'Detected language of the extracted text',
  'PDF Status':'Whether a PDF has been obtained: Stored = in Zotero; Downloaded = fetched separately',
  'Doc Type':'How the PDF\u2019s text was produced: Embedded = native text; Scanned = image requiring OCR',
  'Text Quality':'Automated quality rating of extracted text (good / suspect / garbled)',
  'Quality Score':'Numerical extraction quality (0\u20131) based on character density; blank until extraction runs',
  'Recommendation':'Automated disposition after quality assessment',
  'Extracted':'Whether text extraction has been run for this item',
  'Availability':'Whether this item is freely accessible, paywalled, or unavailable online'
};
function tipIcon(label) {
  var tip=FIELD_TIPS[label];
  return tip ? '<span class="field-info" title="'+escHtml(tip)+'">\u24d8</span>' : '';
}
function dipRow(label, value) {
  return '<div class="dip-row"><span class="dip-label">'+escHtml(label)+tipIcon(label)+'</span><span class="dip-value">'+value+'</span></div>';
}

function showDocInfo(key) {
  var r = null;
  for (var i=0;i<DATA.length;i++) if(DATA[i].key===key){r=DATA[i];break;}
  if (!r) return;

  var panel   = document.getElementById('doc-info-panel');
  var overlay = document.getElementById('doc-info-overlay');
  var body    = document.getElementById('dip-body');
  var html = '';

  // Title
  if (r.has_reader) {
    html += '<div class="dip-title"><a href="reader.html?key='+r.key+collectionQS('&')+'">'+escHtml(r.title)+'</a></div>';
  } else if (r.url) {
    html += '<div class="dip-title"><a href="'+escHtml(r.url)+'" target="_blank">'+escHtml(r.title)+'</a></div>';
  } else {
    html += '<div class="dip-title">'+escHtml(r.title)+'</div>';
  }
  if (r.pub_title) html += '<div class="dip-pub">'+escHtml(r.pub_title)+'</div>';

  // Badges
  html += '<div class="dip-badges">'
    +pdfBadge(r.pdf_status)+typeBadge(r.doc_type)+availBadge(r._availability)
    +(r.language?'<span class="badge b-lang">'+escHtml(r.language)+'</span>':'')
    +(r.item_type?'<span class="badge b-itype">'+escHtml(r.item_type)+'</span>':'')
    +qualityBadge(r.text_quality||'')
    +(r.has_reader?'<span class="badge b-stored">\ud83d\udcd6 Reader</span>':'')
    +'</div>';

  // Tags
  var tags = r.tags||[];
  if (tags.length) {
    html += '<div class="dip-tags">'+tags.map(function(t){return '<span class="badge b-tag">'+escHtml(t)+'</span>';}).join('')+'</div>';
  }

  // Details
  html += '<div class="dip-section">Details</div>';
  var rowIdx = currentData.indexOf(r);
  if (rowIdx>=0) html += dipRow('Row',(rowIdx+1)+' of '+currentData.length);
  html += dipRow('Key','<code style="font-size:11px;color:#999">'+r.key+'</code>');
  if (r.item_type)  html += dipRow('Item Type', escHtml(r.item_type.replace(/([A-Z])/g,' $1').trim()));
  if (r.pub_title)  html += dipRow('Publication','<em>'+escHtml(r.pub_title)+'</em>');
  if (r.publisher)  html += dipRow('Publisher',escHtml(r.publisher));
  if (r.place)      html += dipRow('Place',escHtml(r.place));
  if (r.year)       html += dipRow('Year',escHtml(r.year));
  if (r.authors)    html += dipRow('Authors',escHtml(r.authors));
  if (r.pages)      html += dipRow('Pages',escHtml(r.pages));
  html += dipRow('PDF pages', r.page_count!=null ? String(r.page_count) : '\u2014');
  if (r.language)   html += dipRow('Language',r.language.toUpperCase());
  html += dipRow('PDF Status',escHtml(r.pdf_status||'\u2014'));
  if (r.doc_type&&r.doc_type!=='unknown') html += dipRow('Doc Type',escHtml(r.doc_type));
  if (r.text_quality)   html += dipRow('Text Quality',escHtml(r.text_quality));
  if (r.quality_score!=null) html += dipRow('Quality Score',r.quality_score.toFixed(2));
  if (r.recommendation) html += dipRow('Recommendation',recBadge(r.recommendation));
  html += dipRow('Extracted', r.extracted ? '<span style="color:#1a7f37">Yes</span>' : '<span style="color:#999">No</span>');
  if (r._availability) html += dipRow('Availability',availBadge(r._availability));
  if (r.url) html += dipRow('URL','<a href="'+escHtml(r.url)+'" target="_blank" rel="noopener">'+(r.url.length>45?escHtml(r.url.slice(0,45))+'\u2026':escHtml(r.url))+'</a>');

  // Abstract
  if (r.abstract) {
    html += '<div class="dip-section">Abstract</div>';
    html += '<div class="dip-abstract">'+escHtml(r.abstract)+'</div>';
  }
  // Notes
  var notes = r.notes||[];
  if (notes.length) {
    html += '<div class="dip-section">Zotero Notes</div>';
    html += notes.map(function(n){return '<div class="dip-notes">'+escHtml(typeof n==='string'?n:(n.note||''))+'</div>';}).join('');
  }
  // Actions
  html += '<div class="dip-actions">';
  if (r.has_reader) html += '<a href="reader.html?key='+r.key+collectionQS('&')+'">Open Reader</a>';
  if (r.url) html += '<a href="'+escHtml(r.url)+'" target="_blank" rel="noopener" class="secondary">Open URL</a>';
  html += '</div>';

  body.innerHTML = html;
  panel.classList.add('open');
  overlay.classList.add('open');
}

function closeDocInfo() {
  document.getElementById('doc-info-panel').classList.remove('open');
  document.getElementById('doc-info-overlay').classList.remove('open');
}
document.addEventListener('keydown',function(e){ if(e.key==='Escape') closeDocInfo(); });

/* ---- GitHub Actions ---- */
var GITHUB_URL = '';
(function(){
  var m = window.location.hostname.match(/^([^.]+)\.github\.io$/);
  if (m) {
    var owner=m[1], repo=window.location.pathname.split('/').filter(Boolean)[0]||'';
    GITHUB_URL='https://github.com/'+owner+'/'+repo;
  }
})();

function getGithubToken() {
  var token = localStorage.getItem('scholion_gh_pat');
  if (token) return token;
  token = prompt('Enter a GitHub Personal Access Token with Actions write permission.\nFine-grained: Actions \u2192 Read & write (this repo only).\nYour token is saved in this browser\'s localStorage only.');
  if (token && token.trim()) { localStorage.setItem('scholion_gh_pat',token.trim()); return token.trim(); }
  return null;
}
function clearGithubToken() { localStorage.removeItem('scholion_gh_pat'); }

function triggerWorkflow(workflow, inputs, btn, successMsg) {
  if (!GITHUB_URL) { alert('Cannot determine the GitHub repository URL.\nBrowse via GitHub Pages to enable workflow triggers.'); return; }
  var token = getGithubToken();
  if (!token) return;
  var origText = btn.textContent.trim();
  btn.disabled = true; btn.textContent = 'Triggering\u2026';
  var apiUrl = GITHUB_URL.replace('https://github.com/','https://api.github.com/repos/')+'/actions/workflows/'+workflow+'/dispatches';
  var stringInputs = {};
  Object.keys(inputs).forEach(function(k){ stringInputs[k]=String(inputs[k]); });
  fetch(apiUrl, {
    method:'POST',
    headers:{'Authorization':'Bearer '+token,'Accept':'application/vnd.github+json','Content-Type':'application/json'},
    body: JSON.stringify({ref:'main',inputs:stringInputs}),
  }).then(function(r){
    if (r.status===204) {
      btn.textContent='\u2713 '+successMsg; btn.style.color='#1a7f37'; btn.style.borderColor='#34c759';
      var n=document.getElementById('actionsNote'); if(n) n.textContent='Workflow running \u2014 results appear after Pages redeploys (~2\u20133 min).';
      var al=document.getElementById('actionsGhLink'); if(al){al.href=GITHUB_URL+'/actions';al.style.display='';}
    } else if (r.status===401) {
      clearGithubToken(); btn.textContent=origText; btn.disabled=false;
      alert('Token rejected (401) \u2014 may be expired. Token cleared; click again to re-enter.');
    } else if (r.status===403) {
      clearGithubToken(); btn.textContent=origText; btn.disabled=false;
      alert('Permission denied (403).\nEnsure your token has Actions:Read\u00a0&\u00a0write scope.\nToken cleared; click again to re-enter.');
    } else {
      r.text().then(function(t){
        console.error('Workflow dispatch error '+r.status+':',t);
        btn.textContent='Error '+r.status+' \u2014 retry'; btn.title=t; btn.disabled=false;
        var msg=t; try{msg=JSON.stringify(JSON.parse(t),null,2);}catch(e){}
        alert('GitHub API error '+r.status+' while triggering '+workflow+':\n\n'+msg);
      });
    }
  }).catch(function(){ btn.textContent='Network error \u2014 retry'; btn.disabled=false; });
}
</script>
</body>
</html>
