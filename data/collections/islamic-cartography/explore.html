<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Islamic Cartography â€” Explorer</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&display=swap" rel="stylesheet">
<!-- Leaflet for the map view -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:      #111;
  --panel:   #1a1a1a;
  --border:  #2e2e2e;
  --text:    #d8d8d8;
  --muted:   #666;
  --accent:  #0071e3;
  --link:    #5ba3f5;
  --good:    #2d9f5e;
  --warn:    #c49e3b;
  --bad:     #b34040;
}

/* Global link colour â€” readable on dark backgrounds */
a { color: var(--link); text-decoration: none; }
a:hover { color: #7cc0ff; text-decoration: underline; }

body {
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* â”€â”€ Header â”€â”€ */
header {
  background: #0a0a0a;
  border-bottom: 1px solid var(--border);
  padding: 14px 24px;
  display: flex;
  align-items: center;
  gap: 20px;
  flex-shrink: 0;
}
header h1 { font-size: 16px; font-weight: 600; color: #fff; }
header .sub { font-size: 12px; color: var(--muted); flex: 1; }
.site-nav { display: flex; gap: 12px; margin-left: auto; }
.site-nav a {
  font-size: 12px; color: var(--muted); text-decoration: none;
  padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border);
  transition: color .15s, border-color .15s;
}
.site-nav a:hover { color: #fff; border-color: #555; }
.site-nav a.active { color: #fff; border-color: var(--accent); }

/* â”€â”€ Tabs â”€â”€ */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  background: #0d0d0d;
  padding: 0 24px;
  flex-shrink: 0;
}
.tab {
  padding: 10px 20px;
  font-size: 13px;
  cursor: pointer;
  color: var(--muted);
  border-bottom: 2px solid transparent;
  margin-bottom: -1px;
  transition: all .15s;
  user-select: none;
}
.tab.active { color: #fff; border-bottom-color: var(--accent); }
.tab:hover:not(.active) { color: var(--text); }

/* â”€â”€ Filters bar â”€â”€ */
.filters {
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  padding: 10px 24px;
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  flex-shrink: 0;
}
.filters input[type=text] {
  background: #222;
  border: 1px solid #3a3a3a;
  color: var(--text);
  padding: 5px 10px;
  border-radius: 5px;
  font-size: 12px;
  width: 200px;
}
.filters input[type=text]:focus { outline: none; border-color: var(--accent); }
.filters select {
  background: #222;
  border: 1px solid #3a3a3a;
  color: var(--text);
  padding: 5px 8px;
  border-radius: 5px;
  font-size: 12px;
}
.filters label { font-size: 12px; color: var(--muted); display: flex; gap: 6px; align-items: center; }
.filter-count { font-size: 11px; color: var(--muted); margin-left: auto; }

/* â”€â”€ Panels â”€â”€ */
.panel { flex: 1; overflow: hidden; display: none; }
.panel.active { display: flex; flex-direction: column; }

/* â”€â”€ Timeline panel â”€â”€ */
.timeline-wrap {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.chart-area {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px 20px 12px;
}

.chart-title {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 16px;
  text-transform: uppercase;
  letter-spacing: .05em;
}

.histogram {
  display: flex;
  align-items: flex-end;
  gap: 3px;
  height: 160px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 4px;
}

.bar-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  flex: 1;
  min-width: 0;
}
.bar {
  background: var(--accent);
  border-radius: 2px 2px 0 0;
  width: 100%;
  transition: filter .15s;
}
.bar-wrap:hover .bar { filter: brightness(1.3); }
.bar-wrap.selected .bar { background: var(--warn); }
.bar-label {
  font-size: 9px;
  color: var(--muted);
  margin-top: 4px;
  white-space: nowrap;
  transform: rotate(-40deg);
  transform-origin: top left;
  margin-left: 6px;
}

.chart-legend {
  display: flex;
  gap: 16px;
  margin-top: 16px;
  font-size: 11px;
  color: var(--muted);
}

/* â”€â”€ Timeline item list (shown on bar click) â”€â”€ */
.tl-results {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.tl-results-header {
  padding: 10px 16px;
  font-size: 12px;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  background: #161616;
  display: flex;
  align-items: center;
  gap: 8px;
}
.tl-item {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 10px;
  align-items: baseline;
}
.tl-item:last-child { border-bottom: none; }
.tl-item:hover { background: #1f1f1f; }
.tl-year { font-size: 11px; color: var(--muted); min-width: 40px; }
.tl-title { font-size: 13px; color: var(--text); flex: 1; }
.tl-authors { font-size: 11px; color: var(--muted); }

/* â”€â”€ Map panel â”€â”€ */
#map-panel-wrap {
  flex: 1;
  display: flex;
  min-height: 0;
}
#map-panel {
  flex: 1;
  position: relative;
  min-height: 0;
}
#leaflet-map {
  position: absolute;
  inset: 0;
  background: #1a2233;
}
.map-notice {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.75);
  color: var(--text);
  font-size: 12px;
  padding: 8px 16px;
  border-radius: 6px;
  z-index: 1000;
  pointer-events: none;
}
/* Map results side panel */
#map-results {
  width: 320px;
  background: var(--panel);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
#map-results-header {
  padding: 10px 16px;
  font-size: 12px;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  background: #161616;
  flex-shrink: 0;
}
#map-results-body {
  flex: 1;
  overflow-y: auto;
}

/* â”€â”€ List panel â”€â”€ */
.list-wrap {
  flex: 1;
  overflow-y: auto;
  padding: 20px 24px;
}
.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 12px;
}
.card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  transition: border-color .15s;
}
.card:hover { border-color: #444; }
.card-title {
  font-size: 13px;
  font-weight: 500;
  color: #fff;
  line-height: 1.4;
}
.card-title a { color: inherit; text-decoration: none; }
.card-title a:hover { color: var(--accent); }
.card-pub {
  font-size: 11px;
  font-style: italic;
  color: #888;
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.card-meta {
  font-size: 11px;
  color: var(--muted);
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.card-badges { display: flex; gap: 4px; flex-wrap: wrap; }

/* â”€â”€ List toolbar â”€â”€ */
.list-toolbar {
  display: flex; align-items: center; gap: 12px; flex-shrink: 0;
  padding: 8px 16px; background: #111; border-bottom: 1px solid var(--border);
}
.list-sort-group { display: flex; align-items: center; gap: 4px; flex: 1; flex-wrap: wrap; }
.list-sort-label { font-size: 11px; color: var(--muted); margin-right: 4px; }
.sort-btn, .view-btn {
  font-size: 11px; padding: 3px 9px; border-radius: 5px; cursor: pointer;
  background: #1e1e1e; border: 1px solid var(--border); color: var(--muted);
  transition: color .15s, border-color .15s, background .15s;
}
.sort-btn:hover, .view-btn:hover { color: #fff; border-color: #555; }
.sort-btn.active { color: #fff; border-color: var(--accent); background: #1a2a3a; }
#sortDirBtn {
  font-size: 13px; padding: 2px 7px; border-radius: 5px; cursor: pointer;
  background: #1e1e1e; border: 1px solid var(--border); color: var(--muted);
}
#sortDirBtn:hover { color: #fff; }
.view-toggle { display: flex; gap: 4px; }
.view-btn.active { color: #fff; border-color: var(--accent); background: #1a2a3a; }
.list-count { font-size: 11px; color: var(--muted); white-space: nowrap; }

/* â”€â”€ Row view â”€â”€ */
.row-list { display: flex; flex-direction: column; gap: 0; }
.row-item {
  display: grid;
  grid-template-columns: 1fr 140px 80px 90px;
  gap: 0 12px; align-items: start;
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  transition: background .1s;
}
.row-item:hover { background: #181818; }
.row-title { font-size: 13px; font-weight: 500; color: #fff; line-height: 1.3; }
.row-title a { color: inherit; text-decoration: none; }
.row-title a:hover { color: var(--accent); }
.row-pub { font-size: 11px; font-style: italic; color: #888; margin-top: 2px; }
.row-author { font-size: 11px; color: var(--muted); }
.row-year  { font-size: 11px; color: var(--muted); text-align: right; }
.row-place { font-size: 11px; color: var(--muted); }

/* â”€â”€ Badges â”€â”€ */
.badge {
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 10px;
  white-space: nowrap;
}
.b-stored    { background:#1a3a1a; color:#5fba7d; border:1px solid #2a5a2a; }
.b-url       { background:#1a2a3a; color:#5a9fd4; border:1px solid #1a4a6a; }
.b-missing   { background:#2a1a1a; color:#d45a5a; border:1px solid #4a1a1a; }
.b-embedded  { background:#1a1a3a; color:#8888dd; border:1px solid #2a2a5a; }
.b-scanned   { background:#2a1a2a; color:#cc88cc; border:1px solid #4a1a4a; }
.b-itype     { background:#222;    color:#999;    border:1px solid #333; }
.b-lang      { background:#1a2a2a; color:#66aaaa; border:1px solid #1a4a4a; }
.b-good      { background:#0d2a1a; color:#5fba7d; border:1px solid #1a4a2a; }
.b-suspect   { background:#2a2000; color:#d4b05a; border:1px solid #4a3800; }
.b-garbled   { background:#2a1a1a; color:#d47a5a; border:1px solid #4a2a1a; }
.b-oa        { background:#0d200d; color:#5fba7d; border:1px solid #1a4a1a; }
.b-paywalled { background:#2a1a00; color:#d4a05a; border:1px solid #4a3000; }
.b-unavail   { background:#1e1e1e; color:#555;    border:1px solid #2e2e2e; }

/* â”€â”€ Scrollbars â”€â”€ */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

/* â”€â”€ Scholion brand â”€â”€ */
.scholion-logo {
  font-family: 'Cormorant Garamond', Georgia, serif;
  font-size: 20px; font-weight: 600; color: #fff;
  letter-spacing: .04em; text-decoration: none; line-height: 1; flex-shrink: 0;
}
.scholion-logo:hover { color: #ccc; }
.header-divider { color: #444; font-size: 14px; flex-shrink: 0; }
</style>
</head>
<body>

<header>
  <a href="../../index.html" class="scholion-logo">Scholion</a>
  <span class="header-divider">Â·</span>
  <h1>Islamic Cartography â€” Explorer</h1>
  <span class="sub">
    20 items
     Â· 19 PDFs
     Â· 20 extracted
     Â· 18 readers
    Â· 20 dated Â· 5 placed
  </span>
  <nav class="site-nav">
    <a href="../../dashboard.html?collection=islamic-cartography">ğŸ“‹ Dashboard</a>
    <a href="../../explore.html?collection=islamic-cartography" class="active">ğŸ”­ Explorer</a>
  </nav>
</header>

<!-- â”€â”€ Tabs â”€â”€ -->
<div class="tabs">
  <div class="tab"        onclick="switchTab('timeline')">ğŸ“… Timeline</div>
  <div class="tab"        onclick="switchTab('map')">ğŸ—º Map</div>
  <div class="tab active" onclick="switchTab('list')">ğŸ“š List</div>
</div>

<!-- â”€â”€ Filters â”€â”€ -->
<div class="filters">
  <input type="text" id="q" placeholder="Search title, author, keyâ€¦" oninput="applyFilters()">
  <label>Type:
    <select id="fType" onchange="applyFilters()">
      <option value="">All types</option>
      <option value="book">Book</option>
      <option value="journalArticle">Journal article</option>
      <option value="bookSection">Book section</option>
      <option value="encyclopediaArticle">Encyclopedia</option>
      <option value="manuscript">Manuscript</option>
    </select>
  </label>
  <label>PDF:
    <select id="fPdf" onchange="applyFilters()">
      <option value="">All</option>
      <option value="stored">In Zotero</option>
      <option value="downloaded">Downloaded</option>
      <option value="url_only">URL only</option>
      <option value="no_attachment">None</option>
    </select>
  </label>
  <label>Doc:
    <select id="fDoc" onchange="applyFilters()">
      <option value="">All</option>
      <option value="embedded">Embedded</option>
      <option value="scanned">Scanned</option>
    </select>
  </label>
  <label>Lang:
    <select id="fLang" onchange="applyFilters()">
      <option value="">All languages</option>
      <option value="en">English</option>
      <option value="ar">Arabic</option>
      <option value="de">German</option>
      <option value="fr">French</option>
    </select>
  </label>
  <label>Period:
    <select id="fPeriod" onchange="applyFilters()">
      <option value="">All periods</option>
      <option value="ancient">Ancient / Medieval (â€“1500)</option>
      <option value="early_modern">Early Modern (1500â€“1800)</option>
      <option value="19c">19th Century (1800â€“1900)</option>
      <option value="20c">20th Century (1900â€“2000)</option>
      <option value="modern">21st Century (2000â€“)</option>
    </select>
  </label>
  <label>Avail:
    <select id="fAvail" onchange="applyFilters()">
      <option value="">All</option>
      <option value="stored">Stored</option>
      <option value="open_access">Open access</option>
      <option value="restricted">Paywalled</option>
      <option value="unavailable">Unavailable</option>
    </select>
  </label>
  <span class="filter-count" id="filterCount"></span>
</div>

<!-- â”€â”€ TIMELINE PANEL â”€â”€ -->
<div class="panel" id="panel-timeline">
  <div class="timeline-wrap">
    <div class="chart-area">
      <div class="chart-title">Publications by decade</div>
      <div class="histogram" id="histogram"></div>
      <div class="chart-legend">
        <span>Click a bar to see items from that decade</span>
        <span id="tlTotal"></span>
      </div>
    </div>
    <div class="tl-results" id="tl-results" style="display:none">
      <div class="tl-results-header" id="tl-results-header"></div>
      <div id="tl-results-body"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ MAP PANEL â”€â”€ -->
<div class="panel" id="panel-map">
  <div id="map-panel-wrap">
    <div id="map-panel">
      <div id="leaflet-map"></div>
      <div class="map-notice" id="map-notice"></div>
    </div>
    <div id="map-results" style="display:none">
      <div id="map-results-header">Click a location to see publications</div>
      <div id="map-results-body"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ LIST PANEL â”€â”€ -->
<div class="panel active" id="panel-list">
  <div class="list-toolbar">
    <div class="list-sort-group">
      <span class="list-sort-label">Sort:</span>
      <button class="sort-btn active" data-sort="title"    onclick="setListSort('title')">Title</button>
      <button class="sort-btn"        data-sort="authors"  onclick="setListSort('authors')">Author</button>
      <button class="sort-btn"        data-sort="year"     onclick="setListSort('year')">Year</button>
      <button class="sort-btn"        data-sort="pub_title" onclick="setListSort('pub_title')">Publication</button>
      <button class="sort-btn"        data-sort="place"    onclick="setListSort('place')">Place</button>
      <button id="sortDirBtn" onclick="toggleListSortDir()" title="Reverse sort">â†‘</button>
    </div>
    <div class="view-toggle">
      <button id="viewCardBtn" class="view-btn active" onclick="setListView('cards')" title="Card view">âŠ</button>
      <button id="viewRowBtn"  class="view-btn"        onclick="setListView('rows')"  title="Row view">â˜°</button>
    </div>
    <span class="list-count" id="listCount"></span>
  </div>
  <div class="list-wrap">
    <div class="card-grid" id="card-grid"></div>
  </div>
</div>

<script>
// â”€â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DATA       = [{"key": "228AHDGB", "title": "Geography and Mapmaking Until 700/1300", "year": "2023", "authors": "Bonner", "item_type": "bookSection", "place": "", "publisher": "Routledge", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/228AHDGB.pdf", "doc_type": "unknown", "page_count": 14, "avg_chars_pg": 3316.5, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 3316.5, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/228AHDGB.pdf", "pdf_original_name": "Bonner - 2023 - Geography and Mapmaking Until 7001300.pdf", "pdf_staged_at": "2026-02-22T09:40:31", "pdf_zotero_key": "7PWW8EXU"}, {"key": "23K87F66", "title": "Description of the Earth in the Works of Arabic Geographers from IX to XII Century", "year": "2012", "authors": "Cvijanovic", "item_type": "journalArticle", "place": "", "publisher": "", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/23K87F66.pdf", "doc_type": "unknown", "page_count": 5, "avg_chars_pg": 2572.2, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 2572.2, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/23K87F66.pdf", "pdf_original_name": "Cvijanovic - DESCRIPTION OF THE EARTH IN THE WORKS OF ARABIC GE.pdf", "pdf_staged_at": "2026-02-22T09:40:31", "pdf_zotero_key": "N5I96FA4"}, {"key": "2LBD7UE7", "title": "Geographisches WÃ¶rterbuch", "year": "1866", "authors": "Yakut; WÃ¼stenfeld", "item_type": "book", "place": "Leipzig", "publisher": "Leipzig, Brockhaus", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/2LBD7UE7/geographischesw01ytib.pdf", "doc_type": "embedded", "page_count": 980, "avg_chars_pg": 1338.1, "language": "de", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 1338.1}, {"key": "5FBQAZ7C", "title": "Tradition and Innovation in the Cosmology of Anania Å irakacâ€˜i", "year": "2018", "authors": "Pambakian", "item_type": "journalArticle", "place": "", "publisher": "", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/5FBQAZ7C/Pambakian - 2018 - Tradition and Innovation in the Cosmology of Anani.pdf", "doc_type": "unknown", "page_count": 16, "avg_chars_pg": 2522.5, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 2522.5}, {"key": "6ELZA7R7", "title": "Three-Dimensional Astronomy: Celestial globes and armillary spheres", "year": "2023", "authors": "Arslan", "item_type": "bookSection", "place": "", "publisher": "Routledge", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/6ELZA7R7.pdf", "doc_type": "unknown", "page_count": 12, "avg_chars_pg": 2996.7, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 2996.7, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/6ELZA7R7.pdf", "pdf_original_name": "Arslan - 2023 - Three-Dimensional Astronomy Celestial globes and .pdf", "pdf_staged_at": "2026-02-22T09:40:32", "pdf_zotero_key": "6RHCU7CZ"}, {"key": "6Y43BXJ9", "title": "The Astral Sciences through the 7th/13th Century: Attitudes, experts and practices", "year": "2023", "authors": "Brentjes", "item_type": "bookSection", "place": "", "publisher": "Routledge", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/6Y43BXJ9.pdf", "doc_type": "unknown", "page_count": 16, "avg_chars_pg": 3938.2, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 3938.2, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/6Y43BXJ9.pdf", "pdf_original_name": "Brentjes - 2023 - The Astral Sciences through the 7th13th Century .pdf", "pdf_staged_at": "2026-02-22T09:40:32", "pdf_zotero_key": "HBMELKKA"}, {"key": "7SRKVGG3", "title": "Kitab Al Masalik Wa'l-Mamalik det Excerpta de Kitab al-Kharadj", "year": "1889", "authors": "de Goeje; Ibn Khordadbeh; Kodama ibn Dja'far", "item_type": "book", "place": "Leiden", "publisher": "Brill", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/7SRKVGG3/bibliothecageogr06goej.pdf", "doc_type": "embedded", "page_count": 564, "avg_chars_pg": 1504.0, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 1504.0}, {"key": "ANLFTXVL", "title": "The Journey of Maps and Images on the Silk Road", "year": "2008", "authors": "ForÃªt; Kaplony", "item_type": "book", "place": "", "publisher": "Brill", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/ANLFTXVL.pdf", "doc_type": "unknown", "page_count": 278, "avg_chars_pg": 1994.1, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 1994.1, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/ANLFTXVL.pdf", "pdf_original_name": "ForÃªt and Kaplony - 2008 - The Journey of Maps and Images on the Silk Road.pdf", "pdf_staged_at": "2026-02-22T09:40:32", "pdf_zotero_key": "5UDM3XMT"}, {"key": "C9YPFKU3", "title": "Cartography in Islamic Societies", "year": "1976", "authors": "Brentjes; Kitchin; Thrift", "item_type": "encyclopediaArticle", "place": "Oxford", "publisher": "Elsevier", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/C9YPFKU3.pdf", "doc_type": "unknown", "page_count": 15, "avg_chars_pg": 4161.7, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 4161.7, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/C9YPFKU3.pdf", "pdf_original_name": "Brentjes - 1976 - Cartography in Islamic Societies.pdf", "pdf_staged_at": "2026-02-22T09:40:32", "pdf_zotero_key": "GAP6Z6V6"}, {"key": "CR7CQJJ8", "title": "Seven Keshvar or Images of the Climes", "year": "1974", "authors": "Anonymous; Sotoudeh", "item_type": "book", "place": "Tehran", "publisher": "Iran Cultural Foundation", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/CR7CQJJ8/Anonymous - 1974 - Seven Keshvar or Images of the Climes.pdf", "doc_type": "unknown", "page_count": 169, "avg_chars_pg": null, "language": "fa", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": null, "chars_per_page": null}, {"key": "DUZKRZFQ", "title": "Practices of Zoroastrian Scholars Before and After the Advent of Islam", "year": "2023", "authors": "KÃ¶nig", "item_type": "bookSection", "place": "", "publisher": "Routledge", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/DUZKRZFQ.pdf", "doc_type": "unknown", "page_count": 13, "avg_chars_pg": 3605.6, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 3605.6, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/DUZKRZFQ.pdf", "pdf_original_name": "KÃ¶nig - 2023 - Practices of Zoroastrian Scholars Before and After.pdf", "pdf_staged_at": "2026-02-22T09:40:33", "pdf_zotero_key": "WRCR324W"}, {"key": "HMPTGZID", "title": "Against Ptolemy? Cosmography in Early KalÄm (2022)", "year": "2022", "authors": "Anchassi", "item_type": "journalArticle", "place": "", "publisher": "", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/HMPTGZID.pdf", "doc_type": "unknown", "page_count": 31, "avg_chars_pg": 4558.5, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 4558.5, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/HMPTGZID.pdf", "pdf_original_name": "Anchassi - 2022 - Against Ptolemy Cosmography in Early KalÄm (2022).pdf", "pdf_staged_at": "2026-02-22T09:40:33", "pdf_zotero_key": "UWEV3P5P"}, {"key": "IGHBYX4K", "title": "The Pancasiddhantika of Varahamihira", "year": "1970", "authors": "Varahamihira", "item_type": "", "place": "", "publisher": "", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "no_attachment", "pdf_path": "data/collections/islamic-cartography/pdfs/IGHBYX4K/Varahamihira - 1970 - The Pancasiddhantika of Varahamihira.pdf", "doc_type": "embedded", "page_count": 211, "avg_chars_pg": 1477.8, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": false, "text_quality": "good", "chars_per_page": 1477.8}, {"key": "MJEJY7UC", "title": "Die Oberlieferung der altesten arabischen Handschrift von Pseudo Aristoteles 'De Mundo'", "year": "1974", "authors": "Klein-Franke", "item_type": "journalArticle", "place": "", "publisher": "", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/MJEJY7UC.pdf", "doc_type": "unknown", "page_count": 9, "avg_chars_pg": 1974.8, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 1974.8, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/MJEJY7UC.pdf", "pdf_original_name": "Klein-Franke - 1974 - Die Oberlieferung der altesten arabischen Handschr.pdf", "pdf_staged_at": "2026-02-22T09:40:33", "pdf_zotero_key": "7WFBRJIK"}, {"key": "PRZTK6C7", "title": "Cosmology and Cosmic Order in Islamic Astronomy", "year": "2019", "authors": "Morrison", "item_type": "journalArticle", "place": "", "publisher": "", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/PRZTK6C7.pdf", "doc_type": "unknown", "page_count": 27, "avg_chars_pg": 2944.8, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 2944.8, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/PRZTK6C7.pdf", "pdf_original_name": "Morrison - 2019 - Cosmology and Cosmic Order in Islamic Astronomy.pdf", "pdf_staged_at": "2026-02-22T09:40:33", "pdf_zotero_key": "273CCYWF"}, {"key": "QIGTV3FC", "title": "Ptolemy", "year": "2012", "authors": "Sinisgalli", "item_type": "bookSection", "place": "Cambridge", "publisher": "Cambridge University Press", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/QIGTV3FC/Sinisgalli - 2012 - Ptolemy.pdf", "doc_type": "unknown", "page_count": 39, "avg_chars_pg": 1275.7, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 1275.7}, {"key": "QVUQC6HN", "title": "The world as an apple on the hand: the orb and its relationship with medieval cartography", "year": "2013", "authors": "SÃ¡enz-LÃ³pez PÃ©rez", "item_type": "journalArticle", "place": "", "publisher": "", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/QVUQC6HN/SÃ¡enz-LÃ³pez PÃ©rez - 2013 - The world as an apple on the hand the orb and its.pdf", "doc_type": "unknown", "page_count": 13, "avg_chars_pg": 2991.3, "language": "es", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 2991.3}, {"key": "R2BYZE7J", "title": "An Unknown Source of al-KhwÄrizmÄ«â€™s KitÄb á¹£Å«rat al-ará¸.", "year": "2015", "authors": "Straface; De Angelo; Manzo; MarÃ³th", "item_type": "", "place": "", "publisher": "", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/R2BYZE7J.pdf", "doc_type": "unknown", "page_count": 14, "avg_chars_pg": 2511.4, "language": "", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": false, "text_quality": "good", "chars_per_page": 2511.4, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/R2BYZE7J.pdf", "pdf_original_name": "MarÃ³th - 2015 - An Unknown Source of al-KhwÄrizmÄ«â€™s KitÄb á¹£Å«rat al.pdf", "pdf_staged_at": "2026-02-22T09:40:34", "pdf_zotero_key": "AA75YHZL"}, {"key": "W277BB43", "title": "Le roman Ã©pistolaire classique conservÃ© dans la version de Salim Ab l-'Ala", "year": "1967", "authors": "Grignaschi", "item_type": "journalArticle", "place": "", "publisher": "", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/W277BB43.pdf", "doc_type": "unknown", "page_count": 56, "avg_chars_pg": 2390.9, "language": "en", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 2390.9, "pdf_staged_path": "data/collections/islamic-cartography/pdfs/W277BB43.pdf", "pdf_original_name": "Grignaschi - 1967 - Le roman Ã©pistolaire classique conservÃ© dans la ve.pdf", "pdf_staged_at": "2026-02-22T09:40:34", "pdf_zotero_key": "C8NIVWWN"}, {"key": "YEDS3GQH", "title": "C.A. Nallino: Al-Battini sive Albatenii -- Opus Astronomicum", "year": "1899", "authors": "al-Battani; al-Kharaki", "item_type": "book", "place": "", "publisher": "", "abstract": null, "pub_title": null, "pages": null, "url": "", "tags": [], "notes": [], "pdf_status": "stored", "pdf_path": "data/collections/islamic-cartography/pdfs/YEDS3GQH/Nallino_Al-Battini_Opus_astronomicum_Pars1-3_1899.pdf", "doc_type": "embedded", "page_count": 1162, "avg_chars_pg": 2621.0, "language": "la", "extracted": true, "quality_score": null, "recommendation": "", "has_reader": true, "text_quality": "good", "chars_per_page": 2621.0}];
const DECADES    = [{"decade": 1860, "count": 1, "keys": ["2LBD7UE7"]}, {"decade": 1870, "count": 0, "keys": []}, {"decade": 1880, "count": 1, "keys": ["7SRKVGG3"]}, {"decade": 1890, "count": 1, "keys": ["YEDS3GQH"]}, {"decade": 1900, "count": 0, "keys": []}, {"decade": 1910, "count": 0, "keys": []}, {"decade": 1920, "count": 0, "keys": []}, {"decade": 1930, "count": 0, "keys": []}, {"decade": 1940, "count": 0, "keys": []}, {"decade": 1950, "count": 0, "keys": []}, {"decade": 1960, "count": 1, "keys": ["W277BB43"]}, {"decade": 1970, "count": 4, "keys": ["C9YPFKU3", "CR7CQJJ8", "IGHBYX4K", "MJEJY7UC"]}, {"decade": 1980, "count": 0, "keys": []}, {"decade": 1990, "count": 0, "keys": []}, {"decade": 2000, "count": 1, "keys": ["ANLFTXVL"]}, {"decade": 2010, "count": 6, "keys": ["23K87F66", "5FBQAZ7C", "PRZTK6C7", "QIGTV3FC", "QVUQC6HN", "R2BYZE7J"]}, {"decade": 2020, "count": 5, "keys": ["228AHDGB", "6ELZA7R7", "6Y43BXJ9", "DUZKRZFQ", "HMPTGZID"]}];
const MAP_ITEMS  = [{"key": "2LBD7UE7", "title": "Geographisches WÃ¶rterbuch", "year": "1866", "place": "Leipzig", "lat": 51.34, "lng": 12.38, "pdf": "stored", "type": "embedded", "lang": "de"}, {"key": "7SRKVGG3", "title": "Kitab Al Masalik Wa'l-Mamalik det Excerpta de Kitab al-Kharadj", "year": "1889", "place": "Leiden", "lat": 52.16, "lng": 4.49, "pdf": "stored", "type": "embedded", "lang": "en"}, {"key": "C9YPFKU3", "title": "Cartography in Islamic Societies", "year": "1976", "place": "Oxford", "lat": 51.75, "lng": -1.26, "pdf": "stored", "type": "unknown", "lang": "en"}, {"key": "CR7CQJJ8", "title": "Seven Keshvar or Images of the Climes", "year": "1974", "place": "Tehran", "lat": 35.69, "lng": 51.39, "pdf": "stored", "type": "unknown", "lang": "fa"}, {"key": "QIGTV3FC", "title": "Ptolemy", "year": "2012", "place": "Cambridge", "lat": 52.2, "lng": 0.12, "pdf": "stored", "type": "unknown", "lang": "en"}];

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let filtered  = DATA.slice();   // currently filtered items
let activeTab = 'list';         // default to list view
let selectedDecade = null;
let leafletMap = null;
let tlSort = 'year';            // sort field for decade item list: 'year'|'title'|'authors'
let tlSortAsc = true;          // sort direction; false = descending
let listSort    = 'title';      // list-panel sort field
let listSortAsc = true;         // list-panel sort direction
let listView    = 'cards';      // 'cards' | 'rows'

// â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/** Return the best link for an item: reader > URL > null */
function itemHref(r) {
  if (r.has_reader) return `../../reader.html?key=${r.key}&collection=islamic-cartography`;
  if (r.url)        return r.url;
  return null;
}

function itemLink(r, text, extraAttrs) {
  const href = itemHref(r);
  if (!href) return esc(text);
  const target = r.has_reader ? '' : ' target="_blank" rel="noopener"';
  const title  = r.has_reader ? ' title="Open reader"' : '';
  return `<a href="${esc(href)}"${target}${title}${extraAttrs||''}>${esc(text)}</a>`;
}

function periodOf(year) {
  const y = parseInt(year);
  if (isNaN(y)) return '';
  if (y < 1500) return 'ancient';
  if (y < 1800) return 'early_modern';
  if (y < 1900) return '19c';
  if (y < 2000) return '20c';
  return 'modern';
}

function badge(cls, text) {
  return `<span class="badge ${cls}">${esc(text)}</span>`;
}

function pdfBadge(s) {
  if (!s) return '';
  if (s === 'stored')       return badge('b-stored', 'âœ“ Stored');
  if (s === 'downloaded')   return badge('b-stored', 'â¬‡ Downloaded');
  if (s === 'url_only')     return badge('b-url',    'URL only');
  return badge('b-missing', s);
}

function typeBadge(s) {
  if (s === 'embedded') return badge('b-embedded', 'Embedded');
  if (s === 'scanned')  return badge('b-scanned',  'Scanned');
  return '';
}

function qualityBadge(s) {
  if (s === 'good')    return badge('b-good',    'âœ“ good');
  if (s === 'suspect') return badge('b-suspect', 'âš  suspect');
  if (s === 'garbled') return badge('b-garbled', 'âœ— garbled');
  return '';
}

function availabilityBadge(s) {
  // Skip badge if already covered by pdfBadge (stored) or not yet scanned
  if (!s || s === 'stored') return '';
  if (s === 'open_access')  return badge('b-oa',         'Open access');
  if (s === 'restricted' || s === 'unknown')  return badge('b-paywalled', 'Paywalled');
  if (s === 'unavailable')  return badge('b-unavail',    'Unavailable');
  return '';
}

// â”€â”€â”€ Filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilters() {
  const q       = document.getElementById('q').value.toLowerCase();
  const fType   = document.getElementById('fType').value;
  const fPdf    = document.getElementById('fPdf').value;
  const fDoc    = document.getElementById('fDoc').value;
  const fLang   = document.getElementById('fLang').value;
  const fPeriod = document.getElementById('fPeriod').value;
  const fAvail  = document.getElementById('fAvail').value;

  filtered = DATA.filter(r => {
    if (q && !JSON.stringify(r).toLowerCase().includes(q)) return false;
    if (fType   && r.item_type  !== fType)   return false;
    if (fPdf    && r.pdf_status !== fPdf)    return false;
    if (fDoc    && r.doc_type   !== fDoc)    return false;
    if (fLang   && r.language   !== fLang)   return false;
    if (fPeriod && periodOf(r.year) !== fPeriod) return false;
    if (fAvail) {
      const match = r.availability === fAvail ||
                    (fAvail === 'restricted' && r.availability === 'unknown');
      if (!match) return false;
    }
    return true;
  });

  document.getElementById('filterCount').textContent =
    `${filtered.length} / ${DATA.length} items`;

  refreshActiveView();
}

function refreshActiveView() {
  if (activeTab === 'timeline') renderTimeline();
  if (activeTab === 'map')      renderMap();
  if (activeTab === 'list')     renderList();
}

// â”€â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  activeTab = name;
  document.querySelectorAll('.tab').forEach(t => {
    const fn = t.getAttribute('onclick') || '';
    t.classList.toggle('active', fn.includes("'" + name + "'"));
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  // Leaflet must be told to recalculate its size after the container becomes visible
  if (name === 'map' && leafletMap) {
    setTimeout(() => leafletMap.invalidateSize(), 50);
  }
  refreshActiveView();
}

// â”€â”€â”€ Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTimeline() {
  const filteredKeys = new Set(filtered.map(r => r.key));

  if (!DECADES.length) {
    document.getElementById('histogram').innerHTML =
      '<em style="color:#555;font-size:12px">No dated items in corpus.</em>';
    document.getElementById('tl-results').style.display = 'none';
    return;
  }

  // All decades (full range incl. empty) with active-item counts for current filter
  const allDec = DECADES.map(d => ({
    ...d,
    active: d.keys.filter(k => filteredKeys.has(k)),
  }));

  // Scale bars against the tallest active bar (min 1 avoids divide-by-zero)
  const maxCount = Math.max(1, ...allDec.map(d => d.active.length));
  const hist = document.getElementById('histogram');
  const HEIGHT = 152;

  hist.innerHTML = allDec.map(d => {
    const n    = d.active.length;
    const h    = n > 0 ? Math.max(4, Math.round(n / maxCount * HEIGHT)) : 1;
    const sel  = selectedDecade === d.decade ? ' selected' : '';
    // Only label century marks â€” every 10 decades is too cramped
    const showLbl = d.decade % 100 === 0;
    const lbl     = showLbl ? String(d.decade) : 'Â ';
    // Empty bars are rendered dimly so the gaps in the distribution are visible
    const style = n === 0
      ? `height:1px;background:#2a2a2a;`
      : `height:${h}px;`;
    return `<div class="bar-wrap${sel}" onclick="selectDecade(${d.decade})"
              title="${n} item${n !== 1 ? 's' : ''} Â· ${d.decade}s">
      <div class="bar" style="${style}"></div>
      <div class="bar-label" style="${showLbl ? '' : 'opacity:0'}">${lbl}</div>
    </div>`;
  }).join('');

  const total    = allDec.reduce((s, d) => s + d.active.length, 0);
  const nonEmpty = allDec.filter(d => d.active.length > 0).length;
  document.getElementById('tlTotal').textContent =
    `${total} items Â· ${nonEmpty} of ${allDec.length} decades`;

  // Show/hide decade-item list depending on selection state
  if (selectedDecade !== null) {
    showDecadeItems(selectedDecade, filteredKeys);
  } else {
    document.getElementById('tl-results').style.display = 'none';
  }
}

function selectDecade(dec) {
  selectedDecade = (selectedDecade === dec) ? null : dec;
  renderTimeline();
}

function sortItems(items) {
  const dir = tlSortAsc ? 1 : -1;
  return items.slice().sort((a, b) => {
    let cmp;
    if (tlSort === 'title')   cmp = (a.title   || '').localeCompare(b.title   || '');
    else if (tlSort === 'authors') cmp = (a.authors || '').localeCompare(b.authors || '');
    else cmp = (a.year || '').localeCompare(b.year || '');
    return cmp * dir;
  });
}

function setTlSort(s) {
  if (tlSort === s) {
    tlSortAsc = !tlSortAsc;  // same field â†’ reverse direction
  } else {
    tlSort = s;
    tlSortAsc = true;          // new field â†’ reset to ascending
  }
  renderTimeline();
}

function showDecadeItems(dec, filteredKeys) {
  const decData = DECADES.find(d => d.decade === dec);

  // Gather items from this decade that pass the current filter
  const raw = decData
    ? decData.keys
        .filter(k => filteredKeys.has(k))
        .map(k => DATA.find(r => r.key === k))
        .filter(Boolean)
    : [];
  const itemsInDec = sortItems(raw);

  document.getElementById('tl-results').style.display = 'block';

  // Header with sort buttons (active one shows direction arrow)
  const sortBtn = (key, label) => {
    const isActive = tlSort === key;
    const arrow    = isActive ? (tlSortAsc ? ' â†‘' : ' â†“') : '';
    const activeStyle = isActive
      ? 'background:#0071e3;border-color:#0071e3;color:#fff;'
      : '';
    return `<button onclick="setTlSort('${key}')"
      style="${activeStyle}background-blend-mode:normal;border:1px solid #444;color:${isActive?'#fff':'#aaa'};
             padding:2px 10px;border-radius:4px;font-size:11px;cursor:pointer;
             transition:all .15s;background:${isActive?'#0071e3':'#222'}">${label}${arrow}</button>`;
  };
  document.getElementById('tl-results-header').innerHTML =
    `<span>${dec}s â€” ${itemsInDec.length} item${itemsInDec.length !== 1 ? 's' : ''}</span>
     <span style="margin-left:auto;display:flex;gap:5px;align-items:center">
       <span style="font-size:10px;opacity:.5">Sort:</span>
       ${sortBtn('year','Year')} ${sortBtn('title','Title')} ${sortBtn('authors','Author')}
     </span>`;

  if (!itemsInDec.length) {
    const msg = (!decData || !decData.keys.length)
      ? 'No items published in this decade.'
      : 'No items in this decade match the current filters.';
    document.getElementById('tl-results-body').innerHTML =
      `<div style="padding:16px;color:#555;font-size:13px">${msg}</div>`;
    return;
  }

  document.getElementById('tl-results-body').innerHTML = itemsInDec.map(r => {
    const readerIcon = r.has_reader ? ' ğŸ“–' : '';
    return `<div class="tl-item">
      <span class="tl-year">${esc(r.year || '?')}</span>
      <span class="tl-title">${itemLink(r, r.title + readerIcon)}</span>
      <span class="tl-authors">${esc((r.authors||'').split(';')[0])}</span>
    </div>`;
  }).join('');
}

// â”€â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMap() {
  if (!leafletMap) {
    leafletMap = L.map('leaflet-map', {
      center: [30, 20],
      zoom:   2,
      zoomControl: true,
    });
    L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
      {
        attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19,
      }
    ).addTo(leafletMap);
    // Force size recalc â€” the panel may have been invisible when the map was created
    setTimeout(() => leafletMap.invalidateSize(), 100);
  }

  // Clear existing markers
  leafletMap.eachLayer(layer => {
    if (layer instanceof L.CircleMarker) leafletMap.removeLayer(layer);
  });

  const filteredKeys = new Set(filtered.map(r => r.key));
  const visible = MAP_ITEMS.filter(m => filteredKeys.has(m.key));

  const notice = document.getElementById('map-notice');

  if (MAP_ITEMS.length === 0) {
    notice.textContent = 'Run scripts/03_inventory.py to populate place-of-publication data.';
    notice.style.display = 'block';
  } else {
    notice.textContent = `${visible.length} items with known place Â· ${MAP_ITEMS.length} total geocoded`;
    notice.style.display = 'block';
  }

  // Group by location (lat/lng rounded to 1dp)
  const groups = {};
  visible.forEach(m => {
    const gk = `${m.lat.toFixed(1)},${m.lng.toFixed(1)}`;
    (groups[gk] = groups[gk] || { lat: m.lat, lng: m.lng, items: [] }).items.push(m);
  });

  Object.values(groups).forEach(g => {
    const r = Math.min(18, 5 + g.items.length * 1.5);
    const placeName = g.items[0].place;
    L.circleMarker([g.lat, g.lng], {
      radius: r,
      color:        '#0071e3',
      fillColor:    '#0071e3',
      fillOpacity:  0.6,
      weight:       1,
    }).on('click', () => showMapPlace(placeName, g.items))
      .addTo(leafletMap);
  });
}

/** Show publications for a clicked map location in the side panel. */
function showMapPlace(placeName, mapItems) {
  // Resolve to full DATA records so we get has_reader, url, etc.
  const raw = mapItems
    .map(m => DATA.find(r => r.key === m.key))
    .filter(Boolean);
  const items = sortItems(raw);

  const panel  = document.getElementById('map-results');
  const header = document.getElementById('map-results-header');
  const body   = document.getElementById('map-results-body');

  panel.style.display = 'flex';

  header.innerHTML =
    `<b>${esc(placeName)}</b> â€” ${items.length} item${items.length !== 1 ? 's' : ''}
     <button onclick="document.getElementById('map-results').style.display='none';
                      if(leafletMap) setTimeout(()=>leafletMap.invalidateSize(),50);"
       style="margin-left:auto;background:none;border:none;color:#666;cursor:pointer;
              font-size:14px;line-height:1" title="Close">âœ•</button>`;

  if (!items.length) {
    body.innerHTML = '<div style="padding:16px;color:#555;font-size:13px">No items match current filters.</div>';
  } else {
    body.innerHTML = items.map(r => {
      const readerIcon = r.has_reader ? ' ğŸ“–' : '';
      return `<div class="tl-item">
        <span class="tl-year">${esc(r.year || '?')}</span>
        <span class="tl-title">${itemLink(r, r.title + readerIcon)}</span>
        <span class="tl-authors">${esc((r.authors||'').split(';')[0])}</span>
      </div>`;
    }).join('');
  }

  // The map panel shrank â€” tell Leaflet to recalculate
  if (leafletMap) setTimeout(() => leafletMap.invalidateSize(), 50);
}

// â”€â”€â”€ List sort / view controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setListSort(field) {
  if (listSort === field) { listSortAsc = !listSortAsc; }
  else { listSort = field; listSortAsc = true; }
  document.querySelectorAll('.sort-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.sort === field);
  });
  document.getElementById('sortDirBtn').textContent = listSortAsc ? 'â†‘' : 'â†“';
  renderList();
}

function toggleListSortDir() {
  listSortAsc = !listSortAsc;
  document.getElementById('sortDirBtn').textContent = listSortAsc ? 'â†‘' : 'â†“';
  renderList();
}

function setListView(view) {
  listView = view;
  document.getElementById('viewCardBtn').classList.toggle('active', view === 'cards');
  document.getElementById('viewRowBtn' ).classList.toggle('active', view === 'rows');
  renderList();
}

// â”€â”€â”€ List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList() {
  const grid = document.getElementById('card-grid');

  // Sort
  const sorted = filtered.slice().sort((a, b) => {
    const av = (a[listSort] || '').toString().toLowerCase();
    const bv = (b[listSort] || '').toString().toLowerCase();
    return listSortAsc ? av.localeCompare(bv) : bv.localeCompare(av);
  });

  const countEl = document.getElementById('listCount');
  if (countEl) countEl.textContent = sorted.length + ' items';

  if (!sorted.length) {
    grid.innerHTML = '<p style="color:var(--muted);font-size:13px">No items match current filters.</p>';
    return;
  }

  if (listView === 'rows') {
    grid.className = 'row-list';
    grid.innerHTML = sorted.map(r => {
      const titleHtml = itemLink(r, r.title);
      const pubHtml   = r.pub_title ? `<div class="row-pub">${esc(r.pub_title)}</div>` : '';
      return `<div class="row-item">
        <div><div class="row-title">${titleHtml}${r.has_reader ? ' ğŸ“–' : ''}</div>${pubHtml}</div>
        <div class="row-author">${esc((r.authors||'').split(';')[0])}</div>
        <div class="row-year">${esc(r.year||'â€”')}</div>
        <div class="row-place">${esc(r.place||'â€”')}</div>
      </div>`;
    }).join('');
  } else {
    grid.className = 'card-grid';
    grid.innerHTML = sorted.map(r => {
      const readerBadge = r.has_reader
        ? `<span class="badge b-stored" title="Reader available">ğŸ“– Reader</span>`
        : '';
      const titleHtml = itemLink(r, r.title);
      const pubHtml  = r.pub_title ? `<div class="card-pub">${esc(r.pub_title)}</div>` : '';
      const meta = [(r.authors||'').split(';')[0], r.year, r.place].filter(Boolean).join(' Â· ');
      const tq   = r.text_quality;
      return `<div class="card">
        <div class="card-title">${titleHtml}</div>
        ${pubHtml}
        <div class="card-meta">${esc(meta)}</div>
        <div class="card-badges">
          ${pdfBadge(r.pdf_status)}
          ${availabilityBadge(r.availability)}
          ${typeBadge(r.doc_type)}
          ${r.language ? badge('b-lang', r.language) : ''}
          ${badge('b-itype', r.item_type || '')}
          ${tq ? qualityBadge(tq) : ''}
          ${readerBadge}
        </div>
      </div>`;
    }).join('');
  }
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Empty-state: show setup prompt when there are no items yet
if (DATA.length === 0) {
  document.querySelector('.tabs').style.display = 'none';
  document.querySelector('.toolbar').style.display = 'none';
  document.getElementById('content').innerHTML = `
    <div style="text-align:center; padding:80px 24px; color:#888;">
      <h2 style="font-size:22px; color:#fff; margin-bottom:16px; font-weight:600;">
        Your library is empty
      </h2>
      <p style="margin-bottom:8px; max-width:480px; margin-left:auto; margin-right:auto; line-height:1.6;">
        No items have been imported yet. Run the <strong>First-time setup</strong>
        workflow to connect your Zotero library and import your bibliography.
      </p>
      <p style="margin-bottom:32px; max-width:480px; margin-left:auto; margin-right:auto;
          font-size:13px; color:#555;">
        Go to the <strong>Actions</strong> tab in your GitHub repository â†’
        <strong>First-time setup</strong> â†’ <strong>Run workflow</strong>
      </p>
      <a href="../../actions" target="_top"
         style="background:#0071e3; color:#fff; padding:12px 28px;
                border-radius:8px; text-decoration:none; font-size:14px; font-weight:600;
                display:inline-block;">
        Open Actions tab
      </a>
    </div>`;
} else {
  applyFilters();
}
</script>
</body>
</html>