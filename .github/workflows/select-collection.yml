name: Select Collection

# ── Triggers ──────────────────────────────────────────────────────────────────
# Run manually to add a Zotero library or collection to data/collections.json,
# then automatically build Phase 1 (metadata sync + explorer) so the collection
# is immediately browsable.
#
# First run "Discover Collections" to generate data/discovered_collections.json,
# then copy the selector string from the index.html discovery cards and paste it
# here — or use the one-click "Add Collection" button on index.html.
#
# Selector format:
#   G:<group_id>:                  entire group library (e.g. G:5166884:)
#   G:<group_id>:<collection_key>  specific collection  (e.g. G:5166884:ABCD1234)
#   U::                            your personal library (all items)
#   U::<collection_key>            specific collection in personal library
#
on:
  workflow_dispatch:
    inputs:
      selector:
        description: "Selector string (copy from the index.html discovery card)"
        required: true
        default: ""

permissions:
  contents: write

jobs:
  select:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install dependencies
        run: pip install pyzotero python-dotenv

      - name: Validate selector
        run: |
          SEL="${{ inputs.selector }}"
          if [ -z "$SEL" ]; then
            echo "ERROR: selector is required"
            exit 1
          fi
          # Basic format check
          if [[ ! "$SEL" =~ ^(G:[0-9]+:|U::) ]]; then
            echo "ERROR: selector must start with G:<group_id>: or U::"
            echo "  Examples: G:5166884:   G:5166884:ABCD1234   U::   U::KEY123"
            exit 1
          fi
          echo "Selector: $SEL"

      - name: Check discovered_collections.json exists
        run: |
          if [ ! -f data/discovered_collections.json ]; then
            echo "ERROR: data/discovered_collections.json not found."
            echo "  Run the 'Discover Collections' workflow first."
            exit 1
          fi

      - name: Add collection to collections.json
        id: add
        run: |
          python scripts/select_collections.py --add "${{ inputs.selector }}"

          # Extract the slug of the newly added collection for the build step
          SLUG=$(python3 -c "
          import json
          d = json.load(open('data/collections.json'))
          cols = d.get('collections', [])
          # The most recently added collection is the last one
          if cols:
              print(cols[-1]['slug'])
          ")
          echo "slug=$SLUG" >> "$GITHUB_OUTPUT"
          echo "Collection slug: $SLUG"

      - name: Build Phase 1 (metadata sync + explorer)
        if: steps.add.outputs.slug != ''
        run: |
          echo "Building Phase 1 for: ${{ steps.add.outputs.slug }}"
          python scripts/build_collection.py --slug "${{ steps.add.outputs.slug }}" --phase 1
        env:
          ZOTERO_API_KEY: ${{ secrets.ZOTERO_API_KEY }}

      - name: Commit all collection files
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/collections.json
          git add data/collections/ || true

          if git diff --staged --quiet; then
            echo "No changes — collection may already be in collections.json."
          else
            COUNT=$(python3 -c "
          import json
          d = json.load(open('data/collections.json'))
          print(len(d.get('collections', [])))
          " 2>/dev/null || echo "?")
            git commit -m "select-collection: added ${{ inputs.selector }} (${COUNT} total, built phase 1)

          Run: ${{ github.run_id }}"
            git pull --rebase origin main
            git push
            echo "Collection added and built. Pages will redeploy automatically."
          fi
